<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Drop It | Soulamore</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Html2Canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="../assets/js/logo.js"></script>

    <style>
        :root {
            --bg-deep: #050510;
            --accent: #4ECDC4;
            --danger: #FF6B6B;
            --text-light: #f1f5f9;
        }

        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Outfit', sans-serif;
            background: var(--bg-deep);
            color: var(--text-light);
            touch-action: none;
            user-select: none;
            cursor: crosshair;
        }

        #gameCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        /* --- UI OVERLAYS --- */
        .ui-layer {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 5;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
        }

        .hud-stats {
            text-shadow: 0 0 10px rgba(78, 205, 196, 0.8);
            font-size: 1.5rem;
            font-weight: 700;
        }

        .heat-container {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 5;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .heat-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #4ECDC4, #FF6B6B);
            transition: width 0.1s linear;
        }

        .exit-btn {
            pointer-events: all;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 20px;
            border-radius: 50px;
            cursor: pointer;
            backdrop-filter: blur(5px);
            transition: 0.3s;
        }

        .exit-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .milestone-popup {
            position: fixed;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            font-weight: 700;
            color: var(--accent);
            text-shadow: 0 0 30px var(--accent);
            opacity: 0;
            transition: 0.5s;
            z-index: 8;
            pointer-events: none;
            text-align: center;
        }

        .milestone-popup.show {
            opacity: 1;
            top: 50%;
        }

        /* Start/End Screens */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            background: rgba(5, 5, 16, 0.85);
            backdrop-filter: blur(10px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 1s;
        }

        .overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .title {
            font-size: 4rem;
            font-weight: 700;
            text-shadow: 0 0 30px rgba(78, 205, 196, 0.5);
            margin-bottom: 10px;
            background: linear-gradient(to right, #fff, #4ECDC4);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 25px;
            /* Added spacing */
        }

        .subtitle {
            margin-bottom: 50px;
            /* Increased from default */
            line-height: 1.6;
        }

        /* GUIDANCE MESSAGE SYSTEM */
        #guidance-container {
            position: fixed;
            top: 15%;
            left: 50%;
            transform: translateX(-50%);
            width: clamp(280px, 90vw, 360px);
            padding: 12px 18px;
            background: rgba(10, 10, 25, 0.65);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 20px;
            color: rgba(255, 255, 255, 0.92);
            font-family: 'Outfit', sans-serif;
            font-size: clamp(13px, 2.5vw, 15px);
            text-align: center;
            line-height: 1.5;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.8s ease-out, transform 0.8s ease-out;
            z-index: 1000;
            box-shadow: 0 0 20px rgba(78, 205, 196, 0.1);
        }

        #guidance-container.visible {
            opacity: 1;
            transform: translateX(-50%) translateY(-5px);
        }

        @media (max-width: 600px) {
            #guidance-container {
                top: 12%;
                width: 85%;
            }
        }

        .btn {
            background: var(--accent);
            color: var(--bg-deep);
            padding: 15px 50px;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: 700;
            border: none;
            cursor: pointer;
            box-shadow: 0 0 30px rgba(78, 205, 196, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 50px rgba(78, 205, 196, 0.6);
        }

        /* --- END CARD PREVIEW --- */
        .card-preview {
            width: 280px;
            aspect-ratio: 9/16;
            background: #111;
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.8);
            margin-bottom: 20px;
            overflow: hidden;
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* --- HIDDEN HIGH-RES TEMPLATE --- */
        #shareTemplate {
            display: none;
        }
    </style>
</head>

<body>

    <canvas id="gameCanvas"></canvas>

    <!-- HUD -->
    <div class="ui-layer" id="hud" style="opacity:0; align-items: center;">
        <a href="../index.html" class="exit-btn" style="text-decoration:none; padding:8px 15px; margin-right:auto;"><i
                class="fas fa-arrow-left"></i> Home</a>

        <div class="hud-stats" style="position:absolute; left:50%; transform:translateX(-50%);">
            <span id="distDisplay">0</span> <span style="font-size:0.8rem; opacity:0.7;">LY</span>
        </div>

        <button class="exit-btn" onclick="endGame()" style="margin-left:auto;">Stop & Rest</button>
    </div>

    <!-- HEAT BAR -->
    <div class="heat-container" id="heatContainer">
        <div class="heat-bar" id="heatBar"></div>
    </div>

    <!-- MILESTONE POPUP -->
    <div class="milestone-popup" id="milestoneMsg">
        100 LY<br><span style="font-size:1.5rem; color:white; font-weight:400;">Keep Flying</span>
    </div>

    <!-- START SCREEN -->
    <!-- START SCREEN -->
    <a href="../index.html" class="exit-btn"
        style="position:fixed; top:20px; left:20px; z-index:9999; display:flex; gap:10px;"><i
            class="fas fa-arrow-left"></i> Back</a>

    <style>
        .key-cap {
            display: inline-block;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.9em;
            margin: 0 2px;
            color: #4ECDC4;
            box-shadow: 0 2px 0 rgba(255, 255, 255, 0.1);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(78, 205, 196, 0.1);
            border: 1px solid rgba(78, 205, 196, 0.3);
            border-radius: 20px;
            font-size: 0.8rem;
            color: #4ECDC4;
            margin-bottom: 20px;
        }

        /* MOBILE HUD OPTIMIZATION */
        @media (max-width: 600px) {
            .hud-stats {
                font-size: 1.1rem !important;
                width: 100px;
            }

            #distDisplay {
                font-size: 1.4rem;
            }

            .exit-btn {
                padding: 6px 12px !important;
                font-size: 0.85rem !important;
            }
        }
    </style>

    <div id="guidance-container"></div>
    <div id="startScreen" class="overlay active">
        <div class="badge"><i class="fas fa-headphones"></i> Sound Recommended</div>
        <div class="title" style="margin-bottom:10px;">Drop It.</div>
        <h3 style="margin-bottom:30px; font-weight:400; opacity:0.7;">Mental Space Shooter</h3>

        <div class="subtitle">
            Blast away the heavy thoughts. Keep what matters.<br><br>
            <span class="desktop-hint"><span class="key-cap">WASD</span> to Fly. <span class="key-cap">SPACE</span> to
                Fire.</span>
            <span class="mobile-hint" style="display:none; color:#4ECDC4;">ðŸ‘† Drag to Fly.<br>ðŸ”¥ Drag to Bottom Zone to
                Channel Fire.</span>
            <style>
                @media (hover: none) and (pointer: coarse) {
                    .desktop-hint {
                        display: none;
                    }

                    .mobile-hint {
                        display: inline-block !important;
                    }
                }
            </style>
        </div>
        <button id="igniteBtn" class="btn" style="z-index:99999; pointer-events:auto !important; cursor:pointer;">IGNITE
            ENGINE <i class="fas fa-rocket"></i></button>
    </div>

    <!-- Fire Zone Visual -->
    <div id="fireZone"
        style="position:fixed; bottom:0; left:0; width:100%; height:15vh; background:linear-gradient(to top, rgba(239, 68, 68, 0.3), transparent); pointer-events:none; opacity:0; transition:opacity 0.5s; display:flex; justify-content:center; align-items:flex-end; padding-bottom:20px; font-weight:bold; letter-spacing:2px; color:rgba(255,255,255,0.7); text-transform:uppercase;">
        CHANNEL ZONE
    </div>
    <style>
        @media (hover: none) and (pointer: coarse) {
            .active-game #fireZone {
                opacity: 1 !important;
            }
        }

        /* END SCREEN REFACTOR (Grid Layout) */
        .end-btn-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 100%;
            max-width: 400px;
            margin-top: 25px;
        }

        .btn-small {
            padding: 12px 10px;
            font-size: 1rem;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-align: center;
            min-height: 80px;
        }

        .btn-gold {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #FFD700;
            color: #FFD700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
            animation: pulseGold 2s infinite;
        }

        @keyframes pulseGold {
            0% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); }
            50% { box-shadow: 0 0 25px rgba(255, 215, 0, 0.6); }
            100% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); }
        }

        #endScreen .stats-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 320px;
        }
    </style>
    <!-- END SCREEN -->
    <!-- END SCREEN -->
    <div id="endScreen" class="overlay">
        <h2 style="font-size: 2.5rem; margin-bottom: 5px;">Journey Paused</h2>
        <div style="font-size: 1.2rem; opacity: 0.8; margin-bottom: 20px;">Take a deep breath.</div>

        <div class="stats-box">
            <div style="font-size: 0.9rem; letter-spacing: 1px; margin-bottom: 5px; opacity:0.7;">DISTANCE TRAVELLED</div>
            <div id="finalScore" style="font-size: 4rem; font-weight: 700; color: white; line-height: 1;">0</div>
            <div style="font-size: 0.8rem; margin-top: 15px; font-style: italic;">"You cleared your mind properly."</div>
        </div>

        <div class="end-btn-grid">
            <!-- 1. Reflection (Gold Glow) -->
            <button class="btn btn-small btn-gold" onclick="showLessons()" style="grid-column: span 2;">
                <i class="fas fa-sparkles" style="font-size: 1.4rem;"></i>
                <span>Moment of Reflection</span>
            </button>

            <!-- 2. Share -->
            <button class="btn btn-small" id="shareBtn" onclick="webShare()" style="background: #4ECDC4; color: #0f172a; border:none;">
                <i class="fas fa-share-alt" style="font-size: 1.4rem;"></i>
                <span>Share Story</span>
            </button>

            <!-- 3. Download -->
            <button class="btn btn-small" id="downBtn" onclick="downloadImage()" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3);">
                <i class="fas fa-download" style="font-size: 1.4rem;"></i>
                <span>Save Card</span>
            </button>

            <!-- 4. Fly Again -->
            <button class="btn btn-small" onclick="initGame()" style="grid-column: span 2; margin-top: 10px; background: transparent; border: 1px solid rgba(78, 205, 196, 0.5); color: #4ECDC4;">
                <i class="fas fa-redo"></i> Fly Again
            </button>
        </div>

        <div style="margin-top: 20px; font-size: 0.8rem; opacity: 0.6;">
            <i class="fas fa-volume-up"></i> Sound Recommended
        </div>

        <div style="display:flex; gap:20px; margin-top:20px; font-size:1.1rem;">
            <a href="../index.html" style="color:rgba(255,255,255,0.6); text-decoration:none; transition:0.3s;"
                onmouseover="this.style.color='white'" onmouseout="this.style.color='rgba(255,255,255,0.6)'"><i
                    class="fas fa-home"></i> Home</a>
            <a href="../tools/mental-playground.html"
                style="color:rgba(255,255,255,0.6); text-decoration:none; transition:0.3s;"
                onmouseover="this.style.color='white'" onmouseout="this.style.color='rgba(255,255,255,0.6)'"><i
                    class="fas fa-brain"></i> Playground</a>
            <a href="../peers.html" style="color:rgba(255,255,255,0.6); text-decoration:none; transition:0.3s;"
                onmouseover="this.style.color='white'" onmouseout="this.style.color='rgba(255,255,255,0.6)'"><i
                    class="fas fa-users"></i> Peers</a>
        </div>
    </div>
    </div>

    <!-- TEMPLATE FOR SHARE GENERATOR -->
    <div id="shareTemplate">
        <div id="shareContainerInner"
            style="width: 1080px; height: 1920px; font-family: 'Outfit', sans-serif; color: white; display: flex; flex-direction: column; align-items: center; padding: 90px; box-sizing: border-box; background-color: #000; background: radial-gradient(circle at 50% 15%, #2a2a55 0%, #050510 70%); text-align:center;">

            <!-- Logo (Sourced via Base64 logic below to guarantee load) -->
            <img id="tpl_logo" src="" style="width: 450px; margin-bottom: 20px; margin-top:20px;" alt="Soulamore">
            <!-- Fallback Text if Logo breaks -->
            <h1 style="display:none; font-size:5rem; margin-bottom:20px; margin-top:20px;">SOULAMORE</h1>

            <!-- Big Stats (Resized) -->
            <div style="margin-top:200px; margin-bottom:60px;">
                <div
                    style="font-size:1.6rem; opacity:0.6; letter-spacing:5px; margin-bottom:5px; font-weight:600; text-transform:uppercase;">
                    MY JOURNEY</div>
                <div style="font-size:18rem; font-weight:900; line-height:0.85; color:#fff; text-shadow:0 0 100px rgba(255,255,255,0.6);"
                    id="tpl_shareDist">0</div>
                <div style="font-size:1.8rem; opacity:0.7; font-weight:400; letter-spacing:1px;">Light Years Travelled
                </div>
            </div>

            <!-- List of Dropped Items -->
            <div
                style="background:rgba(255,255,255,0.06); padding:60px 40px; border-radius:50px; width:90%; border:2px solid rgba(255,255,255,0.15); margin-bottom:40px; margin-top:20px; box-shadow: 0 0 60px rgba(255,255,255,0.1);">
                <div
                    style="font-size:2rem; opacity:0.9; text-transform:uppercase; letter-spacing:3px; margin-bottom:30px; font-weight:800;">
                    TODAY I CRUSHED:</div>
                <div id="tpl_droppedList"
                    style="font-size:3rem; color:#fff; line-height:1.3; font-weight:800; display:flex; flex-wrap:wrap; justify-content:center; gap:20px; text-shadow: 0 2px 10px rgba(0,0,0,0.5);">
                </div>

                <!-- Social Hook Inside Box -->
                <div
                    style="margin-top:50px; padding-top:40px; border-top:1px solid rgba(255,255,255,0.2); font-size:2.2rem; font-style:italic; opacity:1; line-height:1.4;">
                    "I burst these worries today.<br>What will you let go of?"
                </div>
            </div>

            <!-- Random Quote (Bottom) -->
            <div style="margin-top:auto; font-size:3rem; max-width:900px; line-height:1.4; opacity:1; font-weight:600;"
                id="tpl_shareQuote"></div>

            <!-- Branding Footer -->
            <div
                style="margin-top:60px; margin-bottom:40px; font-size:1.6rem; opacity:0.6; letter-spacing:3px; text-transform:uppercase;">
                Find your peace at soulamore.com
            </div>

        </div>
    </div>


    <script src="../assets/js/logo.js?v=2"></script>
    <script>
        /* --- ASSETS PRELOADER --- */
        // Safe Logo Handling: Avoid name collision with external const
        let internalLogo = "";
        if (typeof logoBase64 !== 'undefined') {
            internalLogo = logoBase64;
            console.log("Logo Loaded from external file.");
        } else {
            console.warn("Logo.js failed. Using empty fallback.");
        }

        // Legacy Preloader Removed (Now using external logo.js)

        /* --- GAME ENGINE --- */
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        let running = false;
        let speed = 0;
        let maxSpeed = 3.5; // Zen Cap (Reduced from 5)
        let distance = 0;
        let score = 0;
        let droppedWords = [];
        let pulses = [];

        // Heat System
        let heat = 0;
        const maxHeat = 100;
        let overheated = false;
        let fireRateCounter = 0;

        let keys = { ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false, w: false, a: false, s: false, d: false, " ": false };
        let isTouchFiring = false;

        // GUIDANCE MESSAGES DATA
        // INTRUSIVE POPUP CONTENT (The "Ads")
        // INTRUSIVE POPUP CONTENT (The "Enemies" to Shoot)
        const thoughtContent = [
            // ðŸ’” Relationships & Love
            { title: "HEARTBREAK", body: "My ex cheated on me." },
            { title: "MISSING", body: "I still miss someone who hurt me." },
            { title: "DOUBT", body: "I wasnâ€™t enough for them." },
            { title: "MOVED ON", body: "They moved on so fast." },
            { title: "STALKING", body: "I keep checking their profile." },
            { title: "UNLOVED", body: "I loved more than they did." },
            { title: "REPLACED", body: "I feel replaceable." },
            { title: "WHY?", body: "Why did they choose someone else?" },
            { title: "REGRET", body: "I stayed longer than I should have." },
            { title: "UNLOVABLE", body: "I feel unlovable." },

            // ðŸŽ“ Studies & Career
            { title: "FAILED", body: "I failed my exams." },
            { title: "CONFUSED", body: "I donâ€™t understand anything I study." },
            { title: "BEHIND", body: "Everyone else is doing better." },
            { title: "WRONG PATH", body: "I chose the wrong career." },
            { title: "STUPID", body: "I feel stupid in class." },
            { title: "FAILING", body: "Iâ€™m falling behind." },
            { title: "LOST", body: "I donâ€™t know what Iâ€™m doing." },
            { title: "PRESSURE", body: "Iâ€™m scared of disappointing my parents." },
            { title: "HATE IT", body: "I hate what Iâ€™m studying." },
            { title: "FAILURE", body: "I feel like a failure." },

            // ðŸ’¼ Work & Money
            { title: "JOB HATE", body: "I hate my job." },
            { title: "BROKE", body: "Iâ€™m underpaid." },
            { title: "FIRED?", body: "Iâ€™m scared of getting fired." },
            { title: "MISTAKE", body: "I made a mistake at work." },
            { title: "STUCK", body: "I feel stuck here." },
            { title: "POOR", body: "I donâ€™t earn enough." },
            { title: "OVERLOAD", body: "Everyone expects too much from me." },
            { title: "SLOW", body: "I canâ€™t keep up." },
            { title: "TIRED", body: "Iâ€™m exhausted all the time." },
            { title: "MONDAY", body: "I dread Mondays." },

            // ðŸ§  Mental Health & Self
            { title: "OVERTHINK", body: "I overthink everything." },
            { title: "INSOMNIA", body: "I canâ€™t sleep properly." },
            { title: "ANXIETY", body: "I feel anxious for no reason." },
            { title: "NUMB", body: "I feel numb." },
            { title: "MASKING", body: "Iâ€™m tired of pretending Iâ€™m okay." },
            { title: "HATE", body: "I hate my thoughts." },
            { title: "EMPTY", body: "I feel empty." },
            { title: "SELF-HATE", body: "I donâ€™t like myself." },
            { title: "BROKEN", body: "I feel broken." },
            { title: "UNKNOWN", body: "I donâ€™t know whatâ€™s wrong with me." },

            // ðŸ§â€â™‚ï¸ Loneliness & Social
            { title: "ALONE", body: "I feel lonely even around people." },
            { title: "UNKNOWN", body: "No one really knows me." },
            { title: "OUTSIDER", body: "I donâ€™t belong anywhere." },
            { title: "OPTION", body: "Iâ€™m always the second choice." },
            { title: "IGNORED", body: "People donâ€™t text me back." },
            { title: "INVISIBLE", body: "I feel invisible." },
            { title: "NO FRIENDS", body: "I donâ€™t have close friends." },
            { title: "AWKWARD", body: "I feel awkward everywhere." },
            { title: "MISFIT", body: "I donâ€™t fit in." },
            { title: "LEFT OUT", body: "I feel left out." },

            // ðŸ‘¨â€ðŸ‘©â€ðŸ‘¦ Family Pressure
            { title: "EXPECTATIONS", body: "My parents expect too much." },
            { title: "SILENCE", body: "I canâ€™t talk to my family." },
            { title: "SHAME", body: "I feel like a disappointment." },
            { title: "MISUNDERSTOOD", body: "They donâ€™t understand me." },
            { title: "DRAMA", body: "Iâ€™m tired of family drama." },
            { title: "CONTROL", body: "I feel controlled." },
            { title: "MASK", body: "I canâ€™t be myself at home." },
            { title: "COMPARED", body: "I feel compared all the time." },
            { title: "GUILT", body: "I feel guilty for wanting more." },
            { title: "TRAPPED", body: "I feel trapped." },

            // ðŸ“± Modern Life & Comparison
            { title: "ENVY", body: "Everyone is doing better than me." },
            { title: "SOCIALS", body: "Social media makes me feel worse." },
            { title: "SCROLLING", body: "I keep scrolling instead of living." },
            { title: "COMPARING", body: "I compare my life to others." },
            { title: "LAGGING", body: "I feel behind in life." },
            { title: "HAPPIER?", body: "Everyone looks happier than me." },
            { title: "MISSED OUT", body: "I feel like I missed my chance." },
            { title: "FUTURE", body: "Iâ€™m scared of the future." },
            { title: "SUCCESS", body: "I feel pressure to succeed." },
            { title: "LOST", body: "I feel lost." },

            // ðŸ§â€â™€ï¸ Body & Self-Image
            { title: "LOOKS", body: "I hate how I look." },
            { title: "UGLY", body: "I feel ugly." },
            { title: "BODY", body: "I donâ€™t like my body." },
            { title: "JUDGED", body: "I feel judged." },
            { title: "INSECURE", body: "Iâ€™m insecure about everything." },
            { title: "CONFIDENCE", body: "I donâ€™t feel confident." },
            { title: "MIRRORS", body: "I avoid mirrors." },
            { title: "SKIN", body: "I feel uncomfortable in my skin." },
            { title: "ATTRACTION", body: "I feel unattractive." },
            { title: "CHANGE", body: "I wish I looked different." },

            // ðŸŒªï¸ Existential & Quiet Fears
            { title: "PURPOSE", body: "I donâ€™t know my purpose." },
            { title: "WASTE", body: "What if I waste my life?" },
            { title: "STAGNANT", body: "Iâ€™m scared nothing will change." },
            { title: "TIME", body: "I feel like time is running out." },
            { title: "DIRECTION", body: "I donâ€™t know where Iâ€™m headed." },
            { title: "AIMLESS", body: "I feel directionless." },
            { title: "FAILING", body: "Iâ€™m scared of failing again." },
            { title: "TRUST", body: "I donâ€™t trust myself." },
            { title: "OVERWHELM", body: "I feel overwhelmed." },
            { title: "TIRED", body: "Iâ€™m tired of trying." },

            // ðŸ•³ï¸ Late-Night Thoughts
            { title: "WHY ME?", body: "Why am I like this?" },
            { title: "MISTAKES", body: "I keep replaying old mistakes." },
            { title: "RESTART", body: "I wish I could restart." },
            { title: "HEAVY", body: "I feel heavy inside." },
            { title: "PEACE", body: "I donâ€™t feel at peace." },
            { title: "STUCK", body: "I feel stuck in my head." },
            { title: "NOISE", body: "I canâ€™t shut my mind off." },
            { title: "ALONE", body: "I feel alone with my thoughts." },
            { title: "FAST", body: "Iâ€™m scared to slow down." },
            { title: "NOT OKAY", body: "I donâ€™t feel okay." }
        ];

        const guidanceMessages = [
            // --- CORE: SOULAMORE (GENERAL TOOL) ---
            { text: "Soulamore gives your thoughts a safe place to land.", type: "feature" },
            { text: "Soulamore is designed for moments when your mind feels crowded.", type: "feature" },
            { text: "Soulamore helps you pause without needing answers.", type: "feature" },
            { text: "Soulamore exists for thoughts you donâ€™t know how to explain.", type: "feature" },
            { text: "Soulamore creates space without asking you to perform.", type: "feature" },
            { text: "Soulamore is a place to unload mental weight gently.", type: "feature" },
            { text: "Soulamore supports reflection without pressure.", type: "feature" },
            { text: "Soulamore helps when holding things quietly gets heavy.", type: "feature" },
            { text: "Soulamore is built for emotional overflow.", type: "feature" },
            { text: "Soulamore makes room for unfinished feelings.", type: "feature" },

            // --- CONFESSION BOX ---
            { text: "The Soulamore Confession Box lets you share thoughts anonymously.", type: "feature" },
            { text: "The Confession Box helps when saying things out loud feels hard.", type: "feature" },
            { text: "Soulamoreâ€™s Confession Box accepts honesty without names.", type: "feature" },
            { text: "The Confession Box gives your thoughts a private release.", type: "feature" },
            { text: "Soulamore Confession Box is for unsaid words.", type: "feature" },
            { text: "The Confession Box allows you to write without judgment.", type: "feature" },
            { text: "Soulamoreâ€™s Confession Box keeps your identity out of it.", type: "feature" },
            { text: "The Confession Box helps unload thoughts safely.", type: "feature" },
            { text: "Soulamore Confession Box is anonymous by design.", type: "feature" },
            { text: "The Confession Box gives heavy thoughts somewhere to go.", type: "feature" },

            // --- PEER SUPPORT ---
            { text: "Soulamore Peer Support lets you talk to someone who listens.", type: "feature" },
            { text: "Peer Support on Soulamore focuses on understanding, not fixing.", type: "feature" },
            { text: "Soulamore Peer Support connects you with real people.", type: "feature" },
            { text: "Peer Support helps when you donâ€™t want advice.", type: "feature" },
            { text: "Soulamore Peer Support offers calm, human listening.", type: "feature" },
            { text: "Peer Support is for conversations without judgment.", type: "feature" },
            { text: "Soulamore Peer Support values being heard.", type: "feature" },
            { text: "Peer Support lets you speak without rehearsing.", type: "feature" },
            { text: "Soulamore Peer Support is about shared understanding.", type: "feature" },
            { text: "Peer Support can make emotional weight feel lighter.", type: "feature" },

            // --- SOULAMORE AWAY ---
            { text: "Soulamore Away supports people living away from home.", type: "feature" },
            { text: "Soulamore Away helps when distance makes emotions louder.", type: "feature" },
            { text: "Soulamore Away is built for relocation and loneliness.", type: "feature" },
            { text: "Soulamore Away listens when home feels far.", type: "feature" },
            { text: "Soulamore Away supports expats and people in transition.", type: "feature" },
            { text: "Soulamore Away understands cultural and emotional shifts.", type: "feature" },
            { text: "Soulamore Away helps when starting over feels heavy.", type: "feature" },
            { text: "Soulamore Away creates connection across distance.", type: "feature" },
            { text: "Soulamore Away is for emotions that travel with you.", type: "feature" },
            { text: "Soulamore Away supports adjustment without pressure.", type: "feature" },

            // --- SOULAMORE CAMPUS ---
            { text: "Soulamore Campus supports students under quiet pressure.", type: "feature" },
            { text: "Soulamore Campus helps with academic stress.", type: "feature" },
            { text: "Soulamore Campus is built for overwhelmed students.", type: "feature" },
            { text: "Soulamore Campus supports burnout and exam pressure.", type: "feature" },
            { text: "Soulamore Campus understands invisible student stress.", type: "feature" },
            { text: "Soulamore Campus helps when expectations pile up.", type: "feature" },
            { text: "Soulamore Campus supports mental wellbeing in education.", type: "feature" },
            { text: "Soulamore Campus is for students who feel behind.", type: "feature" },
            { text: "Soulamore Campus helps when campus life feels heavy.", type: "feature" },
            { text: "Soulamore Campus creates space for student emotions.", type: "feature" },

            // --- SOULBOT ---
            { text: "SoulBot helps you sort thoughts when they feel tangled.", type: "feature" },
            { text: "SoulBot listens anytime without judgment.", type: "feature" },
            { text: "SoulBot helps you reflect through conversation.", type: "feature" },
            { text: "SoulBot is available when talking to people feels hard.", type: "feature" },
            { text: "SoulBot supports emotional clarity through writing.", type: "feature" },
            { text: "SoulBot helps you name what youâ€™re feeling.", type: "feature" },
            { text: "SoulBot is designed for late-night overthinking.", type: "feature" },
            { text: "SoulBot offers calm responses without pressure.", type: "feature" },
            { text: "SoulBot helps you pause and process.", type: "feature" },
            { text: "SoulBot supports emotional awareness gently.", type: "feature" },

            // --- MENTAL PLAYGROUND ---
            { text: "Soulamore Playground tools help release stress interactively.", type: "feature" },
            { text: "Mental Playground tools turn release into action.", type: "feature" },
            { text: "Soulamore Playground offers playful emotional resets.", type: "feature" },
            { text: "Mental Playground helps shift your headspace.", type: "feature" },
            { text: "Soulamore Playground tools help unwind the mind.", type: "feature" },
            { text: "Mental Playground makes emotional release feel lighter.", type: "feature" },
            { text: "Soulamore Playground supports calm through interaction.", type: "feature" },
            { text: "Mental Playground tools help break mental loops.", type: "feature" },
            { text: "Soulamore Playground is for hands-on emotional relief.", type: "feature" },
            { text: "Mental Playground helps thoughts slow down.", type: "feature" },

            // --- FINDING SUPPORT ---
            { text: "Soulamore helps you find the right kind of support.", type: "stat" },
            { text: "Soulamore guides you from self-help to human support.", type: "stat" },
            { text: "Soulamore helps match you with peers or professionals.", type: "stat" },
            { text: "Soulamore supports different needs at different times.", type: "stat" },
            { text: "Soulamore helps you choose support at your pace.", type: "stat" },
            { text: "Soulamore adapts to how heavy things feel.", type: "stat" },
            { text: "Soulamore helps you explore support without commitment.", type: "stat" },
            { text: "Soulamore supports gradual steps toward help.", type: "stat" },
            { text: "Soulamore lets you start small.", type: "stat" },
            { text: "Soulamore supports emotional decision-making.", type: "stat" }
        ];

        let guidanceState = {
            lastShownTime: 0,
            shownCount: 0,
            active: false,
            history: [],
            maxPerSession: 8,
            interval: 25000 // 25 seconds
        };

        function updateGuidanceSystem(timestamp) {
            if (!running || guidanceState.active || guidanceState.shownCount >= guidanceState.maxPerSession) return;
            if (dangerMode || rescueItem) return; // Silent during chaos

            if (timestamp - guidanceState.lastShownTime > guidanceState.interval) {
                showGuidanceMessage(timestamp);
            }
        }

        function showGuidanceMessage(timestamp) {
            const container = document.getElementById('guidance-container');

            // Selection Logic: 80% Feature, 20% Stat
            // Filter available messages ensuring no immediate repeats
            let pool = [];
            const isFeatureRound = Math.random() < 0.8;

            if (isFeatureRound) {
                pool = guidanceMessages.filter(m => m.type === 'feature');
            } else {
                pool = guidanceMessages.filter(m => m.type === 'stat');
            }

            // Exclude last 3 shown to ensure variety
            const recentText = guidanceState.history.slice(-3);
            pool = pool.filter(m => !recentText.includes(m.text));

            // Fallback if pool empty
            if (pool.length === 0) pool = guidanceMessages;

            const selected = pool[Math.floor(Math.random() * pool.length)];

            // Render
            container.innerText = selected.text;
            container.classList.add('visible');
            guidanceState.active = true;
            guidanceState.shownCount++;
            guidanceState.history.push(selected.text);
            guidanceState.lastShownTime = timestamp;

            // Hide after 4.5s
            setTimeout(() => {
                container.classList.remove('visible');
                guidanceState.active = false;
            }, 4500);
        }

        /* Audio */
        let audioCtx;
        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        function sfx(type) {
            if (!audioCtx) return;
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.connect(g);
            g.connect(audioCtx.destination);
            const t = audioCtx.currentTime;

            if (type === 'attach') {
                o.frequency.setValueAtTime(120, t);
                o.frequency.exponentialRampToValueAtTime(60, t + 0.3);
                g.gain.setValueAtTime(0.1, t);
                g.gain.linearRampToValueAtTime(0.01, t + 0.3);
                o.start(t); o.stop(t + 0.3);
            } else if (type === 'shoot') {
                o.type = 'square';
                o.frequency.setValueAtTime(400, t);
                o.frequency.exponentialRampToValueAtTime(100, t + 0.1);
                g.gain.setValueAtTime(0.03, t);
                g.gain.linearRampToValueAtTime(0, t + 0.1);
                o.start(t); o.stop(t + 0.1);
            } else if (type === 'overheat') {
                // Buzz sound
                o.type = 'sawtooth';
                o.frequency.setValueAtTime(150, t);
                o.frequency.linearRampToValueAtTime(80, t + 0.5);
                g.gain.setValueAtTime(0.1, t);
                g.gain.linearRampToValueAtTime(0, t + 0.5);
                o.start(t); o.stop(t + 0.5);
            } else if (type === 'explode') {
                o.type = 'sawtooth';
                o.frequency.setValueAtTime(100, t);
                o.frequency.exponentialRampToValueAtTime(30, t + 0.2);
                g.gain.setValueAtTime(0.05, t);
                g.gain.linearRampToValueAtTime(0, t + 0.2);
                o.start(t); o.stop(t + 0.2);
            } else if (type === 'milestone') {
                o.type = 'sine';
                o.frequency.setValueAtTime(440, t);
                o.frequency.setValueAtTime(880, t + 0.2);
                g.gain.setValueAtTime(0.1, t);
                g.gain.linearRampToValueAtTime(0, t + 1.0);
                o.start(t); o.stop(t + 1.0);
            }
        }

        /* Entities & Content */
        let player = { x: 0, y: 0, r: 20, color: '#4ECDC4' };
        const stars = [];
        const celestials = [];
        const dust = [];
        const missiles = [];
        const explosions = [];
        const rescueParticles = []; // NEW: Magical particles
        let rescueItem = null; // Hope Orb
        let dangerMode = false;

        // Prepare Logo for Rescue Orb
        const rescueLogo = new Image();
        // Use the symbol favicon
        rescueLogo.src = '../assets/images/favicon_symbol.png';
        const words = ["Anxiety", "Depression", "Burnout", "Doomscrolling", "Imposter Syndrome", "Gaslighting", "Ghosting", "FOMO", "Overthinking", "Situationship", "Toxic Positivity", "Social Battery", "Comparison", "Expectations", "Loneliness", "Regret"];

        // INTRUSIVE POPUP CONTENT CONFIG
        const enablePopups = true; // Easy toggle to reverse
        const popups = [];

        const quotes = [
            // General Positivity
            "You are not behind. You are just becoming at your own pace.",
            "You donâ€™t have to earn rest to deserve it.",
            "Who you are on tired days still counts.",
            "Being gentle with yourself is not self-indulgence; itâ€™s self-respect.",
            "You are allowed to outgrow versions of yourself.",
            "You are more than what you manage to hold together.",
            "Some days, surviving quietly is strength.",
            "Not every thought needs your attention.",
            "Anxiety often sounds urgent, but it isnâ€™t always true.",
            "Some worries soften when you let them be unfinished.",
            "Even quiet tears are a form of release.",
            "You are allowed to feel heavy without fixing it immediately.",
            "Healing is not linear; it loops, pauses, and revisits.",
            "Youâ€™re allowed to heal without an audience.",
            "Protecting your peace is not selfish.",
            "You donâ€™t have to hold everything by yourself.",
            "Youâ€™re not meant to carry this alone.",
            "Not everything needs closure today.",
            "Strength can look like softness.",
            "Resilience doesnâ€™t always roar; sometimes it breathes.",
            "Youâ€™re still here â€” that matters.",
            "You donâ€™t have to see the future to keep going.",

            // Closing / Anchor Messages (Added for End Game)
            "Soulamore is here when youâ€™re ready.",
            "Soulamore supports you without rushing.",
            "Soulamore respects your pace.",
            "Soulamore gives space before solutions.",
            "Soulamore supports emotional honesty.",
            "Soulamore makes room for imperfect thoughts.",
            "Soulamore helps carry what feels heavy.",
            "Soulamore is built around listening.",
            "Soulamore supports quiet strength.",
            "Soulamore is a place to breathe."
        ];

        const palettes = [
            'radial-gradient(circle at center, #1e1b4b 0%, #000 100%)',
            'radial-gradient(circle at center, #4c1d95 0%, #000 100%)',
            'radial-gradient(circle at center, #be123c 0%, #000 100%)',
            'radial-gradient(circle at center, #047857 0%, #000 100%)',
            'radial-gradient(circle at center, #0e7490 0%, #000 100%)',
            'linear-gradient(135deg, #1e293b 0%, #0f172a 100%)'
        ];

        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
            player.x = width / 2;
            player.y = height * 0.8;
        }
        window.addEventListener('resize', resize);
        resize();

        for (let i = 0; i < 80; i++) {
            stars.push({
                x: Math.random() * width,
                y: Math.random() * height,
                z: Math.random() * 2 + 0.5
            });
        }

        /* Inputs */
        window.addEventListener('keydown', e => {
            keys[e.key] = true;
        });
        window.addEventListener('keyup', e => keys[e.key] = false);

        /* Touch Support - MOVEMENT & FIRE ZONE */
        canvas.addEventListener('touchstart', e => {
            e.preventDefault();
            const t = e.touches[0];
            player.x = t.clientX;
            player.y = t.clientY - 60;
            // Check Fire Zone (Bottom 15%)
            if (player.y > window.innerHeight * 0.85) isTouchFiring = true;
            else isTouchFiring = false;
        }, { passive: false });

        canvas.addEventListener('touchmove', e => {
            e.preventDefault();
            const t = e.touches[0];
            player.x = t.clientX;
            player.y = t.clientY - 60;
            // Check Fire Zone
            if (player.y > window.innerHeight * 0.85) isTouchFiring = true;
            else isTouchFiring = false;
        }, { passive: false });

        canvas.addEventListener('touchend', e => {
            e.preventDefault();
            isTouchFiring = false;
        }, { passive: false });


        /* Main Loop */
        function loop() {
            // --- ALWAYS RENDER BACKGROUND ---

            // 0. Update Base Speed (Idle vs Running)
            if (!running) speed = 0.5; // Slow drift when idle
            else speed = 5.9; // 1.25x Harder (was 4.7)

            // 1. Draw Background (Dynamic 100 LY Shift)
            // 1. Draw Background (Dynamic 100 LY Shift)
            const phase = Math.floor(distance / 100);
            const targetHue = (240 + (phase * 40)) % 360;
            if (!window.bgHue) window.bgHue = 240;
            window.bgHue += (targetHue - window.bgHue) * 0.02;

            ctx.fillStyle = `hsla(${window.bgHue}, 40%, 8%, 1)`; // No Trail (1.0)
            ctx.fillRect(0, 0, width, height);

            // 2. Stars (Always Move)
            ctx.fillStyle = 'rgba(255, 255, 255, 0.4)';
            stars.forEach(s => {
                s.y += speed * s.z;
                if (s.y > height) {
                    s.y = 0;
                    s.x = Math.random() * width;
                }
                const streakLen = speed * s.z * 0.6;
                ctx.beginPath();
                ctx.fillRect(s.x, s.y, Math.max(1, s.z * 0.8), streakLen);
            });

            // 3. Celestials (Always Move but reduced spawn in idle)
            if (true) { // Always allowing celestials
                if (Math.random() < (running ? 0.0008 : 0.0001)) spawnCelestial();

                // GUIDANCE SYSTEM UPDATE
                updateGuidanceSystem(performance.now());

                celestials.forEach((c, idx) => {
                    c.y += speed * c.z;
                    if (c.y > height + 200) celestials.splice(idx, 1);

                    // Draw Celestial
                    ctx.save();
                    ctx.globalAlpha = 0.3;
                    ctx.translate(c.x, c.y);
                    if (c.type === 'planet') {
                        const grad = ctx.createRadialGradient(-c.r / 3, -c.r / 3, c.r / 10, 0, 0, c.r);
                        grad.addColorStop(0, c.color1);
                        grad.addColorStop(1, c.color2);
                        ctx.fillStyle = grad;
                        ctx.beginPath();
                        ctx.arc(0, 0, c.r, 0, Math.PI * 2);
                        ctx.fill();
                        if (c.hasRing) {
                            ctx.strokeStyle = 'rgba(255,255,255,0.3)';
                            ctx.lineWidth = 4;
                            ctx.beginPath();
                            ctx.ellipse(0, 0, c.r * 1.8, c.r * 0.4, 0.5, 0, Math.PI * 2);
                            ctx.stroke();
                        }
                    } else {
                        ctx.rotate(distance * 0.002);
                        const grad = ctx.createRadialGradient(0, 0, 0, 0, 0, c.r);
                        grad.addColorStop(0, 'rgba(255,255,255,0.8)');
                        grad.addColorStop(0.4, c.color1);
                        grad.addColorStop(1, 'transparent');
                        ctx.fillStyle = grad;
                        for (let arm = 0; arm < 3; arm++) {
                            ctx.rotate((Math.PI * 2) / 3);
                            ctx.beginPath();
                            ctx.ellipse(c.r / 2, 0, c.r, c.r / 3, 0.2, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    }
                    ctx.restore();
                });
            }

            // SPAWN POPUPS (Intrusive Thoughts)
            // Spawn Rate Increased (0.0015 -> 0.003)
            if (running && enablePopups && Math.random() < 0.003) {
                spawnPopup();
            }

            // --- GAME LOGIC (ONLY WHEN RUNNING) ---
            if (running) {
                // Input & Firing
                if ((keys[' '] || keys.Space || isTouchFiring) && !overheated) {
                    if (fireRateCounter <= 0) {
                        fireMissile();
                        fireRateCounter = 5;
                    }
                }
                fireRateCounter--;

                // Heat Logic
                if (!overheated && !keys[' '] && !keys.Space && !isTouchFiring) {
                    heat = Math.max(0, heat - 1.0);
                }
                updateHeatVisuals();

                // Ambient Logic
                let bgR = 5, bgG = 5, bgB = 16;
                let closestDist = Infinity;
                let closestColor = null;
                celestials.forEach(c => {
                    const dx = c.x - width / 2;
                    const dy = c.y - height / 2;
                    const d = Math.sqrt(dx * dx + dy * dy);
                    if (d < closestDist) {
                        closestDist = d;
                        closestColor = c.color1;
                    }
                });
                // Ambient Logic
                // (Removed for Performance)

                distance += speed * 0.06;

                // Player Movement
                const moveSpeed = 12; // 1.5x Faster (was 8)
                if (keys.ArrowUp || keys.w) player.y -= moveSpeed;
                if (keys.ArrowDown || keys.s) player.y += moveSpeed;
                if (keys.ArrowLeft || keys.a) player.x -= moveSpeed;
                if (keys.ArrowRight || keys.d) player.x += moveSpeed;
                player.x = Math.max(20, Math.min(width - 20, player.x));
                player.y = Math.max(20, Math.min(height - 20, player.y));

                // Missiles
                ctx.fillStyle = overheated ? '#FF6B6B' : '#C4FFF9';
                // Shadows removed for performance
                for (let i = missiles.length - 1; i >= 0; i--) {
                    let m = missiles[i];
                    m.y += m.vy;
                    if (m.vx) m.x += m.vx;
                    ctx.beginPath();
                    ctx.arc(m.x, m.y, m.r, 0, Math.PI * 2);
                    ctx.fill();
                    if (m.y < -50 || m.x < -100 || m.x > width + 100) missiles.splice(i, 1);
                    else {
                        // CHECK POPUP COLLISION
                        // We need to check collisions for missiles against popups too
                        for (let j = popups.length - 1; j >= 0; j--) {
                            let p = popups[j];
                            // Hitbox logic
                            // Popup Box: p.x, p.y, p.w, p.h
                            // X Button: p.x + p.w - 22, p.y + 2, 20x20

                            // Check if missile hits the BOX
                            if (m.x > p.x && m.x < p.x + p.w && m.y > p.y && m.y < p.y + p.h) {
                                // Hit the box!
                                missiles.splice(i, 1); // remove missile

                                // HITBOX LOGIC: Only the Close Button (Top Right) kills it INSTANTLY
                                // Button is approx 35x35 at top right
                                const btnSize = 35;
                                const isCloseHit = (m.x > (p.x + p.w - btnSize) && m.y < (p.y + btnSize));

                                if (isCloseHit) {
                                    // CRITICAL HIT - INSTANT DESTROY
                                    createExplosion(m.x, m.y);
                                    popups.splice(j, 1); // Close popup
                                    sfx('explode');
                                    score += 500; // Bonus points
                                } else {
                                    // BODY HIT - DAMAGE (Tanky)
                                    p.hp--;
                                    if (p.hp <= 0) {
                                        // DESTROYED BY DAMAGE
                                        createExplosion(m.x, m.y);
                                        popups.splice(j, 1);
                                        sfx('explode');
                                        score += 500;
                                    } else {
                                        // RESIST / SHAKE
                                        sfx('shoot'); // Just a thud
                                        p.x += (Math.random() - 0.5) * 5;
                                        p.y -= 2; // Knockback
                                        p.isNew = false;
                                    }
                                }
                                break; // Stop checking other collisions for this missile
                            }
                        }
                    }
                }

                // Pulses
                for (let i = pulses.length - 1; i >= 0; i--) {
                    let p = pulses[i];
                    p.r += 10;
                    p.opacity -= 0.08;
                    if (p.opacity <= 0) { pulses.splice(i, 1); continue; }
                    ctx.strokeStyle = `rgba(78, 205, 196, ${p.opacity})`;
                    ctx.lineWidth = 5;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
                    ctx.stroke();
                }

                // Dust (Words)
                const baseRate = 0.036; // Tuned: Reduced by 10% (was 0.040)
                const diffFactor = Math.min(0.06, distance / 18000); // Ramp up slower
                const spawnRate = baseRate + diffFactor;
                if (Math.random() < 0.018) { // Tuned: Reduced spawn chance (was 0.020)
                    const word = words[Math.floor(Math.random() * words.length)];
                    // Dynamic Radius based on text length to prevent overflow
                    // Base 45px + 4px per character roughly
                    const r = Math.max(45, 30 + word.length * 5);

                    dust.push({
                        x: Math.random() * (width - 100) + 50, // Keep onscreen
                        y: -100,
                        text: word,
                        r: r,
                        attached: false,
                        cleared: false,
                        driftX: (Math.random() - 0.5) * 4,
                        driftY: 1 + Math.random() * 2, // Slow Fall
                        hp: Math.floor(r / 15)
                    });
                }

                for (let i = dust.length - 1; i >= 0; i--) {
                    const d = dust[i];
                    if (!d.cleared) {
                        for (let j = missiles.length - 1; j >= 0; j--) {
                            let m = missiles[j];
                            let dx = m.x - d.x;
                            let dy = m.y - d.y;
                            if (Math.sqrt(dx * dx + dy * dy) < d.r + m.r) {
                                // HIT LOGIC
                                m.life = 0; // Destroy missile
                                missiles.splice(j, 1);
                                createExplosion(d.x, d.y); // Small hit fx

                                d.hp--;
                                if (d.hp <= 0) {
                                    sfx('explode');
                                    droppedWords.push(d.text);
                                    dust.splice(i, 1);
                                    gotoNextDust = true;
                                } else {
                                    // Hit reaction
                                    sfx('shoot'); // quiet hit sound
                                    d.r *= 0.9; // Shrink slightly
                                    d.y -= 10; // Push back
                                }
                                break;
                            }
                        }
                    }
                    if (typeof gotoNextDust !== 'undefined' && gotoNextDust) {
                        var gotoNextDust = false;
                        continue;
                    }

                    if (!d.attached) {
                        // REBALANCED SPEED: Readable but relentless
                        const approachSpeed = (speed * 0.15) + 1.5; // Much Slower
                        d.y += approachSpeed + (d.driftY || 0);
                        d.x += (d.driftX || 0);
                        if (d.driftX) d.driftX *= 0.98;
                        if (d.driftY) d.driftY *= 0.98;

                        const dx = player.x - d.x;
                        const dy = player.y - d.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);

                        // INCREASED TRACKING DIFFICULTY (Reduced 10%)
                        // They start chasing from further away and pull harder
                        if (dist < 400) { // Tuned: Reduced range (was 450)
                            const forceMult = 5.4; // Tuned: Reduced pull (was 6.0)
                            const angle = Math.atan2(dy, dx);
                            const intensity = Math.pow(1 - (dist / 400), 2); // Non-linear pull
                            d.x += Math.cos(angle) * (forceMult * intensity);
                            d.y += Math.sin(angle) * (forceMult * intensity);
                        }

                        if (dist < (player.r + d.r - 10)) {
                            d.attached = true;
                            d.offsetX = d.x - player.x;
                            d.offsetY = d.y - player.y;
                            sfx('attach');
                        }
                    } else {
                        d.x = player.x + d.offsetX;
                        d.y = player.y + d.offsetY;
                        d.offsetX *= 0.995;
                        d.offsetY *= 0.995;
                    }
                    if (d.y > height + 400 || d.y < -200 || d.x < -100 || d.x > width + 100) dust.splice(i, 1);
                } // END DUST LOOP

                // DANGER & RESCUE LOGIC (Runs once per frame)
                const attachedCount = dust.filter(d => d.attached).length;
                if (attachedCount > 3) {
                    if (!dangerMode) {
                        dangerMode = true;
                        sfx('overheat'); // Warning sound
                    }
                    player.color = '#FF4136'; // Red Danger
                    // Shake
                    player.x += (Math.random() - 0.5) * 5;

                    // Spawn Rescue Chance
                    if (!rescueItem && Math.random() < 0.01) {
                        rescueItem = { x: Math.random() * width, y: -50, r: 25 };
                    }
                } else {
                    dangerMode = false;
                    player.color = '#4ECDC4';
                }

                if (rescueItem) {
                    rescueItem.y += 3;
                    // Draw Rescue (Soulamore Logo Payload)
                    ctx.save();
                    // Peach Glow (#F49F75)
                    ctx.shadowColor = '#F49F75';
                    ctx.shadowBlur = 30;

                    // Draw Image if loaded, else fallback to circle
                    if (rescueLogo.complete && rescueLogo.naturalHeight !== 0) {
                        ctx.drawImage(rescueLogo, rescueItem.x - rescueItem.r, rescueItem.y - rescueItem.r, rescueItem.r * 2, rescueItem.r * 2);
                    } else {
                        ctx.fillStyle = '#F49F75';
                        ctx.beginPath();
                        ctx.arc(rescueItem.x, rescueItem.y, rescueItem.r, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    ctx.restore();

                    // Collision with Player
                    const dx = player.x - rescueItem.x;
                    const dy = player.y - rescueItem.y;
                    if (Math.sqrt(dx * dx + dy * dy) < player.r + rescueItem.r) {
                        try {
                            sfx('milestone'); // Success sound

                            // MAGIC EXPLOSION
                            if (typeof createRescueExplosion === 'function') {
                                createRescueExplosion(player.x, player.y);
                            }

                            // SAFE REMOVAL: Loop backwards and splice
                            let freedCount = 0;
                            for (let k = dust.length - 1; k >= 0; k--) {
                                if (dust[k].attached) {
                                    // Chain reaction explosions on the enemies being cleared
                                    if (typeof createRescueExplosion === 'function') {
                                        createRescueExplosion(dust[k].x, dust[k].y, true);
                                    }
                                    droppedWords.push(dust[k].text);
                                    dust.splice(k, 1);
                                    freedCount++;
                                }
                            }

                            // Visual Feedback for Rescue
                            if (freedCount >= 0) { // Always show, even if 0 freed, for positive reinforcement
                                const rescueMsg = document.createElement('div');
                                rescueMsg.innerText = "MIND CLEARED";
                                rescueMsg.style.position = "fixed"; // Interact with viewport directly
                                rescueMsg.style.top = "40%";
                                rescueMsg.style.left = "50%";
                                rescueMsg.style.transform = "translate(-50%, -50%)";
                                rescueMsg.style.color = "#F49F75";
                                rescueMsg.style.fontSize = "clamp(2rem, 5vw, 4rem)"; // Responsive font
                                rescueMsg.style.fontFamily = "Outfit, sans-serif";
                                rescueMsg.style.fontWeight = "bold";
                                rescueMsg.style.textShadow = "0 0 30px #F49F75, 0 0 10px white";
                                rescueMsg.style.zIndex = "9999";
                                rescueMsg.style.pointerEvents = "none";
                                rescueMsg.style.whiteSpace = "nowrap"; // Prevent wrapping
                                rescueMsg.style.animation = "floatUpFade 2.5s forwards cubic-bezier(0.25, 1, 0.5, 1)";
                                document.body.appendChild(rescueMsg);
                                setTimeout(() => rescueMsg.remove(), 2500);
                            }

                            rescueItem = null;
                            dangerMode = false;
                            player.color = '#4ECDC4';

                        } catch (e) {
                            console.error("Rescue Logic Crash detected:", e);
                            // Fallback to prevent game freeze
                            rescueItem = null;
                            dangerMode = false;
                        }
                    }

                    if (rescueItem && rescueItem.y > height + 50) rescueItem = null;
                }

                // SPAWN POPUPS (Intrusive Thoughts)
                // Tuned Spawn Rate: Reduced 10% (was 0.0022 -> 0.0020)
                if (running && enablePopups && Math.random() < 0.0020) {
                    spawnPopup();
                }

                // DRAW POPUPS
                popups.forEach((p, i) => {
                    p.x += p.vx;
                    p.y += p.vy;

                    // Draw Window Body
                    ctx.save();
                    ctx.translate(p.x, p.y);

                    // Shadow
                    ctx.fillStyle = 'rgba(0,0,0,0.5)';
                    ctx.fillRect(5, 5, p.w, p.h);

                    // Main Box
                    ctx.fillStyle = '#1e1b4b'; // Dark Blue
                    ctx.strokeStyle = '#F49F75'; // Peach Border
                    ctx.lineWidth = 2;
                    ctx.fillRect(0, 0, p.w, p.h);
                    ctx.strokeRect(0, 0, p.w, p.h);

                    // Title Bar
                    ctx.fillStyle = '#F49F75';
                    ctx.fillRect(0, 0, p.w, 25);

                    // X Button (The Weak Point)
                    ctx.fillStyle = '#FF4136'; // Red
                    ctx.fillRect(p.w - 25, 0, 25, 25);
                    ctx.fillStyle = '#FFF';
                    ctx.font = 'bold 16px sans-serif';
                    ctx.fillText('X', p.w - 18, 18);

                    // Title Text (Left Aligned, avoiding X button)
                    ctx.fillStyle = '#1e1b4b';
                    ctx.font = 'bold 12px sans-serif';
                    ctx.textAlign = 'left';
                    ctx.fillText(p.content.title, 5, 17);

                    // Body Text (Centered with Wrapping)
                    ctx.textAlign = 'center';
                    ctx.fillStyle = '#FFF';
                    ctx.font = '14px sans-serif';
                    // ctx.fillText(p.content.body, p.w / 2, 55); // OLD (No Wrap)
                    wrapText(ctx, p.content.body, p.w / 2, 50, p.w - 20, 18);

                    // Instruction overlay (first few times)
                    if (p.isNew) {
                        ctx.fillStyle = '#F49F75';
                        ctx.font = '10px sans-serif';
                        ctx.textAlign = 'right';
                        ctx.fillText('SHOOT THE [X]', p.w, -5);
                    }

                    ctx.restore();

                    // Despawn
                    if (p.y > height + 100) popups.splice(i, 1);
                });

                // Particles
                for (let i = explosions.length - 1; i >= 0; i--) {
                    let e = explosions[i];
                    e.life--;
                    e.x += e.vx;
                    e.y += e.vy;
                    ctx.globalAlpha = e.life / 30;
                    ctx.fillStyle = e.color || '#F49F75';
                    ctx.beginPath();
                    ctx.arc(e.x, e.y, e.r, 0, Math.PI * 2);
                    ctx.fill();
                    if (e.life <= 0) explosions.splice(i, 1);
                }

                // Rescue Particles (Magical)
                for (let i = rescueParticles.length - 1; i >= 0; i--) {
                    let p = rescueParticles[i];
                    p.life--;
                    p.x += p.vx;
                    p.y += p.vy;
                    p.r *= 0.95; // Shrink

                    ctx.save();
                    ctx.globalAlpha = p.life / 60;
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = p.color;
                    ctx.fillStyle = p.color;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();

                    if (p.life <= 0) rescueParticles.splice(i, 1);
                }
                ctx.globalAlpha = 1;

                // Draw Dust/Player
                checkMilestone(distance);
                document.getElementById('distDisplay').innerText = Math.floor(distance);
                dust.forEach(d => {
                    ctx.beginPath();
                    ctx.fillStyle = d.attached ? 'rgba(255, 80, 80, 0.3)' : 'rgba(20, 20, 40, 0.8)';
                    ctx.strokeStyle = d.attached ? '#ff6b6b' : 'rgba(255,255,255,0.8)';
                    ctx.lineWidth = 2;
                    ctx.arc(d.x, d.y, d.r, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                    ctx.fillStyle = 'white';
                    ctx.font = '700 13px Outfit';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(d.text, d.x, d.y);
                });

                // Player Visuals
                const glow = ctx.createRadialGradient(player.x, player.y, player.r / 2, player.x, player.y, player.r * 3);
                glow.addColorStop(0, player.color);
                glow.addColorStop(1, 'rgba(0,0,0,0)');
                ctx.fillStyle = glow;
                ctx.beginPath();
                ctx.arc(player.x, player.y, player.r * 3, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.arc(player.x, player.y, player.r / 2, 0, Math.PI * 2);
                ctx.fill();
            }

            requestAnimationFrame(loop);
        }

        function fireMissile() {
            heat += 2.5; // Higher heat per shot (was 2.0)
            if (heat >= 100) {
                overheated = true;
                heat = 100;
                sfx('overheat');
                setTimeout(() => {
                    overheated = false; // Quick Cooldown (1.5s)
                    heat = 0;
                }, 1500);
                return;
            }

            sfx('shoot');
            // Mobile Optimization: Single Stream vs Spread
            const isMobile = window.innerWidth < 600;
            const angles = isMobile ? [0] : [0, -0.3, 0.3];

            angles.forEach(a => {
                missiles.push({
                    x: player.x,
                    y: player.y - 20,
                    vx: Math.sin(a) * 10,
                    vy: -15,
                    r: 6
                });
            });
            // Shockwave
            pulses.push({ x: player.x, y: player.y, r: 0, opacity: 1 });
            dust.forEach(d => {
                const dx = d.x - player.x;
                const dy = d.y - player.y;
                if (Math.sqrt(dx * dx + dy * dy) < 250) {
                    d.attached = false;
                    const angle = Math.atan2(dy, dx);
                    d.driftX = Math.cos(angle) * 5;
                    d.driftY = Math.sin(angle) * 5;
                    d.x += Math.cos(angle) * 30;
                    d.y += Math.sin(angle) * 30;
                }
            });
        }

        // Helper for Canvas Text Wrapping
        function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
            const words = text.split(' ');
            let line = '';
            let lines = [];

            for (let n = 0; n < words.length; n++) {
                const testLine = line + words[n] + ' ';
                const metrics = ctx.measureText(testLine);
                const testWidth = metrics.width;
                if (testWidth > maxWidth && n > 0) {
                    lines.push(line);
                    line = words[n] + ' ';
                } else {
                    line = testLine;
                }
            }
            lines.push(line);

            // Draw line by line centered
            for (let k = 0; k < lines.length; k++) {
                ctx.fillText(lines[k], x, y + (k * lineHeight));
            }
        }

        // Input Handling
        function getMousePos(evt) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const clientX = evt.clientX || (evt.touches && evt.touches[0].clientX);
            const clientY = evt.clientY || (evt.touches && evt.touches[0].clientY);
            return {
                x: (clientX - rect.left) * scaleX,
                y: (clientY - rect.top) * scaleY
            };
        }

        function updateHeatVisuals() {
            const bar = document.getElementById('heatBar');
            bar.style.width = heat + '%';

            if (overheated) {
                // Red Glow
                player.color = '#FF6B6B';
                document.getElementById('heatContainer').style.boxShadow = '0 0 15px #FF6B6B';
                // Pulse effect in logic could go here, but color shift is enough
            } else {
                // Interpolate Color back to Teal
                document.getElementById('heatContainer').style.boxShadow = 'none';
                if (heat > 50) player.color = '#FFAA6B'; // Orange warning
                else player.color = '#4ECDC4';
            }

            // UI UPDATE (Restored)
            const hb = document.getElementById('heatBar');
            if (hb) hb.style.width = Math.min(100, Math.max(0, heat)) + '%';
        }


        function createExplosion(x, y) {
            for (let i = 0; i < 8; i++) {
                explosions.push({
                    x: x, y: y,
                    vx: (Math.random() - 0.5) * 5,
                    vy: (Math.random() - 0.5) * 5,
                    life: 20,
                    r: Math.random() * 3 + 2,
                    color: '#FFF'
                });
            }
        }

        // Scheduler removed - logic moved to main loop usage

        function spawnPopup() {
            const w = 300; // Wider
            const h = 120; // Taller
            const x = Math.random() * (width - w);
            popups.push({
                x: x,
                y: -150, // Start higher up
                w: w,
                h: h,
                vx: (Math.random() - 0.5) * 0.5,
                vy: 0.4 + Math.random() * 0.6, // Faster drift
                content: thoughtContent[Math.floor(Math.random() * thoughtContent.length)], // Renamed from adContent
                isNew: true,
                hp: 25 // Tanky! Needs ~25 hits to destroy via body
            });
        }
        function spawnCelestial() {
            const types = ['planet', 'galaxy'];
            const type = types[Math.floor(Math.random() * types.length)];
            const colors = ['#4ECDC4', '#FF6B6B', '#C44DFF', '#FFE66D'];
            celestials.push({
                x: Math.random() * width,
                y: -300,
                z: 0.1 + Math.random() * 0.2,
                r: 50 + Math.random() * 100,
                type: type,
                color1: colors[Math.floor(Math.random() * colors.length)],
                color2: colors[Math.floor(Math.random() * colors.length)],
                hasRing: Math.random() > 0.5
            });
        }
        let lastMilestone = 0;
        const milestones = [100, 500, 1000, 2000, 5000, 10000];
        function checkMilestone(d) {
            const m = milestones.find(val => d >= val && lastMilestone < val);
            if (m) {
                lastMilestone = m;
                sfx('milestone');
                showPopup(`${m} LY`, "Keep Flying");
            }
        }
        function showPopup(main, sub) {
            const el = document.getElementById('milestoneMsg');
            el.innerHTML = `${main}<br><span style="font-size:1.5rem; color:white; font-weight:400;">${sub}</span>`;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 2000);
        }
        /* --- GAME INIT --- */
        function initGame() {
            console.log("Ignite Clicked");
            try {
                // Audio (might be blocked, so wrap in try)
                try { initAudio(); } catch (e) { console.warn("Audio init failed", e); }

                // Hide Start Screen (Explicit ID)
                const startScreen = document.getElementById('startScreen');
                if (startScreen) {
                    startScreen.classList.remove('active');
                    startScreen.style.display = 'none'; // Force hide
                } else {
                    // Fallback
                    const overlay = document.querySelector('.overlay');
                    if (overlay) overlay.classList.remove('active');
                }

                // Show HUD & Heat Bar (Restored)
                const hud = document.getElementById('hud');
                if (hud) hud.style.opacity = '1';

                const heatCont = document.getElementById('heatContainer');
                if (heatCont) heatCont.style.opacity = '1';

                const endScreen = document.getElementById('endScreen');
                if (endScreen) endScreen.classList.remove('active');

                // Reset Stats
                score = 0;
                distance = 0;
                heat = 0;
                droppedWords = [];
                pulses = [];
                overheated = false;
                running = true;

                startAwarenessTimer(); // Start the 5s interrupts

                // Loop is global

            } catch (e) {
                alert("Game Start Error: " + e.message);
                console.error(e);
            }
        }

        // Alias for safety
        function startGame() { initGame(); }

        // --- MINDFULNESS INTERRUPT SYSTEM ---
        let awarenessTimer = null;
        let gameTime = 0;
        const AWARENESS_INTERVAL = 5000; // 5 Seconds (User Request)

        const mindfulQuotes = [
            "Soulamore gives your thoughts a safe place to land.",
            "Soulamore is designed for moments when your mind feels crowded.",
            "Soulamore helps you pause without needing answers.",
            "Soulamore exists for thoughts you don't know how to explain.",
            "Soulamore creates space without asking you to perform.",
            "Soulamore is a place to unload mental weight gently.",
            "Soulamore supports reflection without pressure.",
            "Soulamore helps when holding things quietly gets heavy.",
            "Soulamore is built for emotional overflow.",
            "Soulamore makes room for unfinished feelings."
        ];

        function startAwarenessTimer() {
            if (awarenessTimer) clearInterval(awarenessTimer);
            awarenessTimer = setInterval(() => {
                if (running && !document.hidden && !document.getElementById('endScreen').classList.contains('active')) {
                    triggerAwarenessPopup();
                }
            }, AWARENESS_INTERVAL);
        }

        function triggerAwarenessPopup() {
            // Pause Game
            running = false;

            // Create Modal
            const overlay = document.createElement('div');
            overlay.id = 'awarenessModal';
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(15, 23, 42, 0.95)';
            overlay.style.zIndex = '20000';
            overlay.style.display = 'flex';
            overlay.style.flexDirection = 'column';
            overlay.style.alignItems = 'center';
            overlay.style.justifyContent = 'center';
            overlay.style.backdropFilter = 'blur(10px)';
            overlay.style.transition = 'opacity 0.5s';
            overlay.style.opacity = '0';

            const quote = mindfulQuotes[Math.floor(Math.random() * mindfulQuotes.length)];

            overlay.innerHTML = `
                <div style="text-align:center; padding:40px; max-width:600px;">
                    <i class="fas fa-feather-alt" style="font-size:3rem; color:#4ECDC4; margin-bottom:30px; opacity:0.8;"></i>
                    <h2 style="font-size:2rem; font-weight:300; line-height:1.4; color:white; margin-bottom:40px; font-family:'Outfit', sans-serif;">
                        "${quote}"
                    </h2>
                    <button id="resumeBtn" style="
                        background: linear-gradient(135deg, #4ECDC4 0%, #2a9d8f 100%);
                        border: none;
                        padding: 15px 50px;
                        font-size: 1.2rem;
                        color: #0f172a;
                        font-weight: bold;
                        border-radius: 50px;
                        cursor: pointer;
                        box-shadow: 0 0 30px rgba(78, 205, 196, 0.3);
                        transition: transform 0.2s;
                    ">Breathe & Resume</button>
                    <div style="margin-top:20px; opacity:0.5; font-size:0.9rem;">Game Paused</div>
                </div>
            `;

            document.body.appendChild(overlay);

            // Animate In
            requestAnimationFrame(() => overlay.style.opacity = '1');

            // Resume Logic
            const btn = overlay.querySelector('#resumeBtn');
            btn.onclick = () => {
                overlay.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(overlay);
                    running = true;
                    loop(); // Restart Loop
                }, 500);
            };
        }

        /* --- SHARE CARD GENERATION --- */
        function endGame() {
            running = false;
            if (awarenessTimer) clearInterval(awarenessTimer); // Stop interrupts
            document.getElementById('hud').style.opacity = 0;
            document.getElementById('heatContainer').style.opacity = 0;
            document.getElementById('endScreen').classList.add('active');

            const randColor = palettes[Math.floor(Math.random() * palettes.length)];
            const randQuote = quotes[Math.floor(Math.random() * quotes.length)];

            // Store for sharing
            window.lastGameData = { color: randColor, quote: randQuote };

            // Set Favicon Symbol or Fallback Text
            const logoEl = document.getElementById('tpl_logo');
            const titleEl = logoEl ? logoEl.nextElementSibling : null;

            if (logoEl) {
                if (logoBase64 && logoBase64.length > 200) {
                    logoEl.src = logoBase64;
                    logoEl.style.display = 'block';
                    if (titleEl) titleEl.style.display = 'none';
                } else {
                    logoEl.style.display = 'none';
                    if (titleEl) titleEl.style.display = 'block';
                }
                logoEl.style.backgroundColor = "transparent";
                logoEl.style.borderRadius = "0";
                logoEl.style.padding = "0";
            }

            if (typeof generateImage === 'function') {
                // Generate preview only first
                generateImage(randColor, randQuote, true);
            }
        }

        // New Independent Functions
        // NEW: Robust Fallback Modal for Mobile
        function showSaveModal(blob) {
            const url = URL.createObjectURL(blob);
            const overlay = document.createElement('div');
            overlay.id = 'saveModalOverlay';
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0,0,0,0.92)';
            overlay.style.zIndex = '100000';
            overlay.style.display = 'flex';
            overlay.style.flexDirection = 'column';
            overlay.style.alignItems = 'center';
            overlay.style.justifyContent = 'center';
            overlay.style.backdropFilter = 'blur(10px)';
            overlay.style.opacity = '0';
            overlay.style.transition = 'opacity 0.3s';

            // Image Container
            const imgCont = document.createElement('div');
            imgCont.style.position = 'relative';
            imgCont.style.display = 'flex';
            imgCont.style.flexDirection = 'column';
            imgCont.style.alignItems = 'center';

            // Image
            const img = document.createElement('img');
            img.src = url;
            img.style.maxHeight = '65vh';
            img.style.maxWidth = '85vw';
            img.style.borderRadius = '12px';
            img.style.boxShadow = '0 0 40px rgba(78, 205, 196, 0.3)';
            img.style.marginBottom = '25px';
            img.style.border = '2px solid rgba(255,255,255,0.1)';

            // Instructions
            const text = document.createElement('div');
            text.innerHTML = '<span style="font-size:2rem; display:block; margin-bottom:10px;">ðŸ‘†</span>Long Press Image<br><span style="font-size:0.9em; opacity:0.7;">to Share or Save to Photos</span>';
            text.style.color = 'white';
            text.style.textAlign = 'center';
            text.style.fontFamily = 'Outfit, sans-serif';
            text.style.fontSize = '1.3rem';
            text.style.fontWeight = '600';
            text.style.lineHeight = '1.4';

            // Close Button
            const closeBtn = document.createElement('button');
            closeBtn.innerText = 'Done';
            closeBtn.style.marginTop = '30px';
            closeBtn.style.padding = '12px 40px';
            closeBtn.style.background = 'rgba(255,255,255,0.15)';
            closeBtn.style.border = '1px solid rgba(255,255,255,0.4)';
            closeBtn.style.color = 'white';
            closeBtn.style.borderRadius = '50px';
            closeBtn.style.fontSize = '1.1rem';
            closeBtn.style.fontWeight = '600';
            closeBtn.style.cursor = 'pointer';
            closeBtn.onclick = () => {
                overlay.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(overlay)) document.body.removeChild(overlay);
                    URL.revokeObjectURL(url);
                }, 300);
            };

            imgCont.appendChild(img);
            imgCont.appendChild(text);
            overlay.appendChild(imgCont);
            overlay.appendChild(closeBtn);
            document.body.appendChild(overlay);

            // Animate In
            requestAnimationFrame(() => overlay.style.opacity = '1');
        }

        async function webShare() {
            const btn = document.getElementById('shareBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

            try {
                // Generate Blob
                const blob = await generateImage(null, null, false, true);
                if (!blob) throw new Error("Image Capture Failed");

                const file = new File([blob], "soulamore-story.png", { type: "image/png" });

                // Optimistic Share with Timeout
                if (navigator.share) {
                    const sharePromise = navigator.share({
                        files: [file],
                        title: 'My Soulamore',
                        text: 'Cleared my mind on Soulamore.',
                    });

                    // If share takes too long (e.g. browser hangs), show modal? 
                    // No, native share blocks main thread often. just await it.
                    await sharePromise;
                    btn.innerHTML = 'Shared! <i class="fas fa-check"></i>';
                } else {
                    throw new Error("Navigator Share not available");
                }
            } catch (err) {
                console.warn("Share failed (likely not supported for files):", err);
                // Fallback to Modal
                showSaveModal(await generateImage(null, null, false, true).catch(e => null) || new Blob());
                btn.innerHTML = 'Image Ready <i class="fas fa-check"></i>';
            }
            setTimeout(() => btn.innerHTML = originalText, 4000);
        }

        async function downloadImage(forceOpen = false) {
            const btn = document.getElementById('downBtn');
            const originalText = btn.innerHTML;
            if (!forceOpen) btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            try {
                const blob = await generateImage(null, null, false, true); // Get Blob
                const url = URL.createObjectURL(blob);

                // Strategy: Link Click (Works on Android/Desktop)
                const link = document.createElement('a');
                link.download = `soulamore-${Date.now()}.png`;
                link.href = url;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Fallback for iOS (Link click doesn't auto-download blobs sometimes)
                // If we are on mobile, we also open it in a new tab just in case the download was blocked
                if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                    setTimeout(() => window.open(url, '_blank'), 100);
                }

                setTimeout(() => URL.revokeObjectURL(url), 10000);

            } catch (e) {
                console.error(e);
                alert("Download failed. Showing verification image.");
                const b = await generateImage(null, null, false, true).catch(e => null);
                if (b) showSaveModal(b);
            }
            if (!forceOpen) btn.innerHTML = 'Download Image <i class="fas fa-download"></i>';
        }

        // Refactored Generator (Returns Promise)
        function generateImage(forceColor, forceQuote, isPreview, returnBlob) {
            return new Promise((resolve, reject) => {
                const tpl = document.getElementById('shareTemplate');
                const clone = tpl.cloneNode(true);
                clone.id = "activeShareCapture";
                clone.style.display = "flex";
                clone.style.position = "fixed";
                clone.style.top = "0px";
                clone.style.left = "0px";
                clone.style.zIndex = "-9999";
                clone.style.opacity = "1";

                // Consistency check for inputs (use existing if null passed aka button click)
                // In a real refactor we'd store these state vars better, but for now we trust the DOM or pass nulls
                // actually, let's grab from the DOM if null, or random logic is duplicated. 
                // ideally endGame calls this once to set preview, then we just re-capture the existing preview? 
                // No, we need high-res. We can grab values from the DOM if needed or just re-generate.
                // Simpler: Reuse the values generated in endGame? 
                // Let's just grab current values from the invisible tpl if possible or just re-render.

                // For simplicity/speed in this patch: Re-read the inputs from the PREVIEW currently on screen?
                // Or just expect them to be passed? 
                // FIX: Let's assume endGame sets global vars for the last result, or we just re-read the hud.
                // Let's rely on the clone logic using the SAME data as `endGame` OR just reading global `distance`.

                const inner = clone.querySelector('#shareContainerInner');
                // Re-apply randoms if provided, else use last (we need to store them if we want exact match)
                // Hack: We'll just re-use the preview logic if arguments are null? 
                // Better: Let's store `lastEndGameData` global.

                if (window.lastGameData) {
                    inner.style.background = window.lastGameData.color;
                    clone.querySelector('#tpl_shareQuote').innerHTML = `"${window.lastGameData.quote}"`;
                }

                clone.querySelector('#tpl_shareDist').innerText = Math.floor(distance);

                let uniqueDrops = [...new Set(droppedWords)];
                if (uniqueDrops.length > 5) uniqueDrops = uniqueDrops.slice(uniqueDrops.length - 5);
                if (uniqueDrops.length === 0) {
                    clone.querySelector('#tpl_droppedList').innerHTML = '<span style="opacity:0.5; font-size:1.5rem;">Nothing... yet.</span>';
                } else {
                    clone.querySelector('#tpl_droppedList').innerHTML = uniqueDrops.map(w =>
                        `<span>${w}</span>`
                    ).join(' <span style="opacity:0.4">â€¢</span> ');
                }

                document.body.appendChild(clone);

                setTimeout(() => {
                    html2canvas(inner, {
                        scale: isPreview ? 0.35 : 2, // Higher res for output
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: null,
                        scrollX: 0,
                        scrollY: -window.scrollY
                    }).then(canvas => {
                        document.body.removeChild(clone);
                        if (isPreview) {
                            const previewImg = document.getElementById('generatedPreview');
                            if (previewImg) previewImg.src = canvas.toDataURL('image/png');
                            resolve(true);
                        } else {
                            if (returnBlob) {
                                canvas.toBlob(blob => resolve(blob), 'image/png');
                            } else {
                                resolve(canvas.toDataURL('image/png'));
                            }
                        }
                    }).catch(reject);
                }, 100);
            });
        }


    <!-- LESSON SCREEN (Post-Download) -->
    <div id="lessonScreen" class="overlay" style="background: radial-gradient(circle at center, #1a1a2e 0%, #0f0f1a 100%); z-index: 21000;">
        <div id="fairyCanvasContainer" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;"></div>
        
        <div class="lesson-container" style="max-width:600px; width:90%; text-align:center; position:relative; z-index:2;">
            <!-- Slides -->
            <div class="lesson-slide active" data-index="0">
                <i class="fas fa-battery-quarter" style="font-size:4rem; color:#FF6B6B; margin-bottom:30px; filter:drop-shadow(0 0 20px rgba(255, 107, 107, 0.5));"></i>
                <h2 style="font-size:2.5rem; margin-bottom:20px; font-weight:300;">Running on Empty</h2>
                <p style="font-size:1.4rem; line-height:1.6; opacity:0.9;">
                    If you keep firing continuously, you will get exhausted. You won't have energy to fight back.<br><br>
                    <span style="color:#4ECDC4;">Take rests in between.</span>
                </p>
            </div>

            <div class="lesson-slide" data-index="1">
                <i class="fas fa-crosshairs" style="font-size:4rem; color:#FFE66D; margin-bottom:30px; filter:drop-shadow(0 0 20px rgba(255, 230, 109, 0.5));"></i>
                <h2 style="font-size:2.5rem; margin-bottom:20px; font-weight:300;">The Power of Focus</h2>
                <p style="font-size:1.4rem; line-height:1.6; opacity:0.9;">
                    Focus on one bubble at a time. Switching consciously makes it easier to cope.<br><br>
                    <span style="color:#4ECDC4;">You won't have to wait to recharge.</span>
                </p>
            </div>

            <div class="lesson-slide" data-index="2">
                <i class="fas fa-hands-helping" style="font-size:4rem; color:#F49F75; margin-bottom:30px; filter:drop-shadow(0 0 20px rgba(244, 159, 117, 0.5));"></i>
                <h2 style="font-size:2.5rem; margin-bottom:20px; font-weight:300;">You Are Not Alone</h2>
                <p style="font-size:1.4rem; line-height:1.6; opacity:0.9;">
                    When you are surrounded and overwhelmed, the Peach Glow will come to clear your mind.<br><br>
                    <span style="color:#4ECDC4;">Help is always there.</span>
                </p>
            </div>

            <div class="lesson-slide" data-index="3">
                <i class="fas fa-spa" style="font-size:4rem; color:#4ECDC4; margin-bottom:30px; filter:drop-shadow(0 0 20px rgba(78, 205, 196, 0.5));"></i>
                <h2 style="font-size:2.5rem; margin-bottom:20px; font-weight:300;">Begin Again</h2>
                <p style="font-size:1.3rem; line-height:1.6; opacity:0.9; margin-bottom:40px;">
                    Try playing again. This time, play with mindfulness.
                </p>
                
                <div style="display:flex; flex-direction:column; gap:15px;">
                    <button class="btn" onclick="location.reload()" style="background: linear-gradient(135deg, #4ECDC4 0%, #2a9d8f 100%); color:#0f172a;">
                        Play Again <i class="fas fa-redo"></i>
                    </button>
                    <button class="btn" onclick="downloadImage(true)" style="background: transparent; border: 1px solid rgba(255,255,255,0.3);">
                        Download Card Again <i class="fas fa-download"></i>
                    </button>
                    <a href="../index.html" class="btn" style="background: transparent; border: 1px solid rgba(255,255,255,0.1); color:rgba(255,255,255,0.8);">
                        Go Home <i class="fas fa-home"></i>
                    </a>
                </div>
            </div>

            <!-- Controls -->
            <div style="margin-top:50px; display:flex; justify-content:center; gap:30px; align-items:center;">
                <button id="prevSlide" onclick="changeSlide(-1)" style="background:none; border:none; color:white; font-size:2rem; cursor:pointer; opacity:0.5; transition:0.3s;"><i class="fas fa-chevron-left"></i></button>
                <div id="slideDots" style="display:flex; gap:10px;">
                    <div class="dot active"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div>
                </div>
                <button id="nextSlide" onclick="changeSlide(1)" style="background:none; border:none; color:white; font-size:2rem; cursor:pointer; opacity:0.8; transition:0.3s;"><i class="fas fa-chevron-right"></i></button>
            </div>
        </div>
    </div>
    <style>
        .lesson-slide { display: none; animation: fadeIn 0.8s ease; }
        .lesson-slide.active { display: block; }
        .dot { width: 10px; height: 10px; background: rgba(255,255,255,0.2); border-radius: 50%; transition: 0.3s; }
        .dot.active { background: #4ECDC4; transform: scale(1.3); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>

    <script>
        // --- LESSON SYSTEM ---
        let currentSlide = 0;
        let slideInterval = null;

        function showLessons() {
            const screen = document.getElementById('lessonScreen');
            screen.classList.add('active');
            
            // Start Fairy Dust
            initFairyDust();

            // Auto-Play slides
            startSlideShow();
        }

        function changeSlide(dir) {
            const slides = document.querySelectorAll('.lesson-slide');
            const dots = document.querySelectorAll('.dot');
            
            slides[currentSlide].classList.remove('active');
            dots[currentSlide].classList.remove('active');
            
            currentSlide += dir;
            if (currentSlide >= slides.length) currentSlide = 0; // Loop or stop? Loop for now.
            if (currentSlide < 0) currentSlide = slides.length - 1;

            // Stop Auto-play on interaction
            if(slideInterval) clearInterval(slideInterval);

            slides[currentSlide].classList.add('active');
            dots[currentSlide].classList.add('active');
        }

        function startSlideShow() {
            if(slideInterval) clearInterval(slideInterval);
            slideInterval = setInterval(() => {
                if(currentSlide < 3) changeSlide(1); // Don't auto-loop fast the last slide
                else clearInterval(slideInterval);
            }, 6000); // 6s per slide
        }

        // --- FAIRY DUST ---
        function initFairyDust() {
            const container = document.getElementById('fairyCanvasContainer');
            const fCanvas = document.createElement('canvas');
            fCanvas.width = window.innerWidth;
            fCanvas.height = window.innerHeight;
            container.appendChild(fCanvas);
            const fCtx = fCanvas.getContext('2d');
            let particles = [];

            // Track Mouse/Touch
            window.addEventListener('mousemove', (e) => spawnDust(e.clientX, e.clientY));
            window.addEventListener('touchmove', (e) => spawnDust(e.touches[0].clientX, e.touches[0].clientY));

            function spawnDust(x, y) {
                for(let i=0; i<3; i++) {
                    particles.push({
                        x: x, y: y,
                        vx: (Math.random() - 0.5) * 2,
                        vy: (Math.random() - 0.5) * 2,
                        life: 1.0,
                        color: `hsl(${Math.random()*60 + 20}, 100%, 70%)` // Gold/Orange/Peach
                    });
                }
            }

            function animate() {
                if(!document.getElementById('lessonScreen').classList.contains('active')) return;
                fCtx.clearRect(0,0, fCanvas.width, fCanvas.height);
                
                for(let i=particles.length-1; i>=0; i--) {
                    let p = particles[i];
                    p.x += p.vx;
                    p.y += p.vy;
                    p.life -= 0.02;
                    fCtx.fillStyle = p.color;
                    fCtx.globalAlpha = p.life;
                    fCtx.beginPath();
                    fCtx.arc(p.x, p.y, Math.random()*3, 0, Math.PI*2);
                    fCtx.fill();
                    if(p.life <= 0) particles.splice(i,1);
                }
                requestAnimationFrame(animate);
            }
            animate();
        }

        function triggerPostGameFlow() {
             // Wait 2-3 seconds after download/share starts, then show lessons
             setTimeout(() => showLessons(), 2500);
        }
    </script>

    <!-- Modified Download/Share triggers to call triggerPostGameFlow() -->
    <script>
        // Override logic injection (Simulated for this snippet)
        // We will manually add triggerPostGameFlow() calls to the download/share functions in the next step
    </script>


        function createRescueExplosion(x, y, isSmall = false) {
            const count = isSmall ? 10 : 30;
            const size = isSmall ? 2 : 4;
            const speed = isSmall ? 5 : 10;

            // Particles
            for (let i = 0; i < count; i++) {
                const angle = Math.random() * Math.PI * 2;
                const v = Math.random() * speed;
                rescueParticles.push({
                    x: x, y: y,
                    vx: Math.cos(angle) * v,
                    vy: Math.sin(angle) * v,
                    life: 60,
                    r: Math.random() * size + 2,
                    color: Math.random() > 0.5 ? '#F49F75' : '#FFD700' // Peach or Gold
                });
            }

            // Shockwave Ring
            if (!isSmall) {
                pulses.push({
                    x: x, y: y,
                    r: 10,
                    maxR: 300,
                    opacity: 1,
                    color: '#F49F75'
                });
            }
        }

        // Start Background Animation
        resize();
        loop();

        (function () {
            // ... listener logic ...
        })();
    </script>

    <!-- NUCLEAR EVENT HANDLER (Safety Script) -->
    <script>
        (function () {
            console.log("--- NUCLEAR SAFETY SCRIPT STARTED ---");
            const btn = document.getElementById('igniteBtn');

            if (!btn) {
                console.error("Button Missing!");
                return;
            }

            // Check if Main Engine Loaded
            if (typeof initGame !== 'function') {
                btn.style.backgroundColor = "red";
                btn.innerText = "ERROR LOADING ENGINE";
                btn.onclick = function () {
                    alert("CRITICAL ERROR:\nThe game engine failed to load.\nThis usually means a SyntaxError or Ad-Blocker blocked the main script.\nPlease check console.");
                };
                return;
            }

            // Attach Robust Listeners
            const ignite = function (e) {
                if (e) { e.preventDefault(); e.stopPropagation(); }
                console.log("NUCLEAR CLICK");
                try {
                    initGame();
                } catch (err) {
                    alert("Runtime Error: " + err.message);
                }
            };

            btn.addEventListener('touchstart', ignite, { passive: false });
            btn.addEventListener('click', ignite);
            console.log("--- NUCLEAR LISTENERS ATTACHED ---");
        })();
    </script>
</body>

</html>