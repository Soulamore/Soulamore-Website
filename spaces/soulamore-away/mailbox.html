<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>You Received a Message | Soulamore Away</title>

    <!-- GLOBAL ASSETS -->
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600&family=Caveat:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../../assets/css/global.css">
    <link rel="icon" href="../../assets/images/favicons/favicon_earth.svg" type="image/svg+xml">

    <style>
        /* --- MIDNIGHT UI DESIGN SYSTEM --- */
        :root {
            --deep-space: #0f172a;
            --navy-glass: rgba(30, 41, 59, 0.6);
            --starlight: #f1f5f9;
            --peach-glow: #F49F75;
            --teal-glow: #4ECDC4;
            --border-glass: rgba(255, 255, 255, 0.08);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--deep-space);
            color: var(--starlight);
            margin: 0;
            padding: 0;
            overflow: hidden;
            /* Prevent scrolling during the ritual */
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            user-select: none;
        }

        /* --- THE RITUAL STAGE --- */
        #stage {
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        /* --- INSTRUCTION TEXT --- */
        .instruction {
            font-family: 'Outfit', sans-serif;
            font-size: 1.5rem;
            letter-spacing: 2px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 40px;
            text-transform: uppercase;
            font-weight: 300;
            transition: opacity 0.5s ease;
            animation: pulse-op 2s infinite;
        }

        @keyframes pulse-op {

            0%,
            100% {
                opacity: 0.5;
            }

            50% {
                opacity: 1;
            }
        }

        /* --- THE POSTCARD WRAPPER --- */
        .postcard-scene {
            width: 90vw;
            max-width: 650px;
            height: 400px;
            perspective: 1500px;
            /* For 3D flip */
        }

        .postcard-object {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 1.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), filter 2s ease-in-out;
            filter: blur(15px) brightness(0.6);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            cursor: pointer;
        }

        /* Front: Blurred Mystery */
        .card-front,
        .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 8px;
            background-color: #fafafa;
            overflow: hidden;
            display: flex;
        }

        .card-front {
            background-image: url('https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?q=80&w=800&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            align-items: center;
            justify-content: center;
        }

        .card-front::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 23, 42, 0.4);
        }

        /* Back: The Actual Message */
        .card-back {
            transform: rotateY(180deg);
            background: #fff;
            color: #1e293b;
            flex-direction: row;
        }

        /* Left Image side of postcard */
        .card-left {
            width: 45%;
            background-image: url('https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?q=80&w=400&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            position: relative;
        }

        /* Right Text side of postcard */
        .card-right {
            width: 55%;
            padding: 30px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            background-image: repeating-linear-gradient(transparent, transparent 31px, #f1f5f9 32px);
            background-position: 0 25px;
        }

        /* Emotion Stamp */
        .emotion-stamp {
            align-self: flex-end;
            border: 2px dashed #94a3b8;
            padding: 5px 10px;
            color: #64748b;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
            transform: rotate(5deg);
        }

        /* Details Overlay */
        .atmosphere-text {
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.8rem;
            color: #94a3b8;
            margin-bottom: 20px;
        }

        .handwritten-message {
            font-family: 'Caveat', cursive;
            font-size: 1.8rem;
            color: #0f172a;
            line-height: 1.5;
            flex-grow: 1;
        }

        .sender-anon {
            text-align: right;
            font-family: 'Outfit', sans-serif;
            font-size: 0.85rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 20px;
        }

        /* --- POST-REVEAL CONTROLS --- */
        #post-controls {
            opacity: 0;
            transform: translateY(20px);
            transition: all 1s ease;
            pointer-events: none;
            /* until revealed */
            margin-top: 40px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .buttons-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .ritual-btn {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid var(--border-glass);
            color: white;
            padding: 14px 28px;
            border-radius: 50px;
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 0.95rem;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(10px);
        }

        .ritual-btn:hover {
            border-color: var(--teal-glow);
            box-shadow: 0 0 20px rgba(78, 205, 196, 0.2);
            transform: translateY(-2px);
        }

        .ritual-btn.primary {
            background: var(--teal-glow);
            color: var(--deep-space);
            font-weight: 600;
        }

        .ritual-btn.save {
            background: transparent;
            border: none;
            color: #94a3b8;
            text-decoration: underline;
        }

        .ritual-btn.save:hover {
            box-shadow: none;
            color: var(--starlight);
        }

        /* --- BACKGROUND PARTICLES --- */
        #ambient-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            background: radial-gradient(circle at 50% 50%, #1e293b, var(--deep-space));
        }

        @media (max-width: 768px) {
            .postcard-scene {
                height: 500px;
            }

            .card-back {
                flex-direction: column;
            }

            .card-left {
                width: 100%;
                height: 35%;
            }

            .card-right {
                width: 100%;
                height: 65%;
                padding: 20px;
            }

            .handwritten-message {
                font-size: 1.5rem;
            }
        }
    </style>
</head>

<body>

    <div id="ambient-bg"></div>

    <!-- Audio Effects -->
    <audio id="sound-rustle" src="https://cdn.freesound.org/previews/150/150035_2604958-lq.mp3"></audio>

    <div id="stage">

        <div class="instruction" id="instruction-text">Hold to Open</div>

        <!-- The 3D Postcard Wrapper -->
        <div class="postcard-scene" id="cardArea">
            <div class="postcard-object" id="postcard">

                <!-- Front - Blurred -->
                <div class="card-front"></div>

                <!-- Back - The Content -->
                <div class="card-back">
                    <div class="card-left"></div>
                    <div class="card-right">
                        <div class="emotion-stamp" id="dynamic-intent">ðŸŒ™ Missing You</div>

                        <div class="atmosphere-text" id="dynamic-overlay">
                            Carrying this from <span style="color:var(--teal-glow);">Berlin</span>...
                        </div>

                        <div class="handwritten-message" id="dynamic-message">
                            "I donâ€™t say this enough, but I appreciate you more than you know. Living here is hard
                            without you."
                        </div>

                        <div class="sender-anon" id="dynamic-sender">
                            â€” Someone who cares
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Reciprocity Actions -->
        <div id="post-controls">
            <div class="buttons-row">
                <button class="ritual-btn primary" onclick="location.href='index.html'"><i class="fas fa-pen"></i> Reply
                    with your own</button>
                <button class="ritual-btn" onclick="alert('Voice Note feature coming soon!')"><i
                        class="fas fa-microphone"></i> Send a Voice Note</button>
                <button class="ritual-btn" onclick="activateCandle(this)"><i class="fas fa-fire"></i> Light a Candle for
                    Them</button>
            </div>
            <button class="ritual-btn save" onclick="saveToCollection()"><i class="fas fa-bookmark"></i> Keep this safe
                in "My Letters"</button>
        </div>

    </div>

    <!-- THE INTERACTIVE LOGIC -->
    <script>
        const postcard = document.getElementById('postcard');
        const instruction = document.getElementById('instruction-text');
        const controls = document.getElementById('post-controls');
        const rustleSound = document.getElementById('sound-rustle');

        let holdTimer;
        let isOpened = false;

        // The "Hold" Mechanic Progress Tracker
        let blurAmount = 15;
        let brightness = 0.6;
        let holdDuration = 1500; // 1.5 seconds to open
        let stepTime = 50;
        let ticksRequired = holdDuration / stepTime;
        let currentTick = 0;

        function startHold(e) {
            // Prevent text selection on mobile devices that triggers a highlight
            if (e) e.preventDefault();

            if (isOpened) return;

            instruction.style.opacity = '0';

            // Start the physical unblurring feeling
            postcard.style.transition = `filter ${stepTime}ms linear`;

            holdTimer = setInterval(() => {
                currentTick++;

                // Calculate new CSS filters (interpolate to blur 0 and bright 1)
                let currentBlur = blurAmount * (1 - (currentTick / ticksRequired));
                let currentBright = brightness + ((1 - brightness) * (currentTick / ticksRequired));

                postcard.style.filter = `blur(${currentBlur}px) brightness(${currentBright})`;

                if (currentTick >= ticksRequired) {
                    completeOpening();
                }
            }, stepTime);
        }

        function cancelHold() {
            if (isOpened) return;

            clearInterval(holdTimer);

            // Reset state if they let go too early
            instruction.style.opacity = '1';
            currentTick = 0;
            postcard.style.transition = 'filter 0.5s ease';
            postcard.style.filter = `blur(${blurAmount}px) brightness(${brightness})`;
        }

        function completeOpening() {
            clearInterval(holdTimer);
            isOpened = true;

            // Play Sound
            rustleSound.volume = 0.4;
            rustleSound.play().catch(e => console.log("Audio requires interaction"));

            // Perform the Flip
            postcard.style.transition = 'transform 1.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
            postcard.style.transform = 'rotateY(180deg) scale(1.05)';

            // Hide instruction permanently
            instruction.style.display = 'none';

            // Fade in the bottom controls after flip
            setTimeout(() => {
                controls.style.opacity = '1';
                controls.style.transform = 'translateY(0)';
                controls.style.pointerEvents = 'all';
                postcard.style.transform = 'rotateY(180deg) scale(1)'; // Settle back down
            }, 1200);
        }

        // Event Listeners for the Hold trigger
        const clickArea = document.getElementById('stage');
        clickArea.addEventListener('mousedown', startHold);
        clickArea.addEventListener('mouseup', cancelHold);
        clickArea.addEventListener('mouseleave', cancelHold);

        // Touch support
        clickArea.addEventListener('touchstart', startHold);
        clickArea.addEventListener('touchend', cancelHold);
        clickArea.addEventListener('touchcancel', cancelHold);


        // --- DYNAMIC CONTENT FROM URL ---
        const urlParams = new URLSearchParams(window.location.search);

        // Escape HTML to prevent XSS
        const escapeHTML = (str) => str ? str.replace(/[&<>'"]/g, tag => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;' }[tag])) : '';

        const msgSrc = escapeHTML(urlParams.get('msg'));
        const citySrc = escapeHTML(urlParams.get('city'));
        const intentSrc = escapeHTML(urlParams.get('intent'));
        const senderSrc = escapeHTML(urlParams.get('sender'));

        if (msgSrc) document.getElementById('dynamic-message').innerText = `"${msgSrc}"`;
        if (citySrc) document.getElementById('dynamic-overlay').innerHTML = `Carrying this from <span style="color:var(--teal-glow);">${citySrc}</span>...`;
        if (intentSrc) document.getElementById('dynamic-intent').innerHTML = `ðŸŒ™ ${intentSrc}`;
        if (senderSrc) document.getElementById('dynamic-sender').innerText = `â€” ${senderSrc}`;

        // --- UI Interactions ---
        function activateCandle(btn) {
            btn.innerHTML = "<i class='fas fa-fire' style='color:var(--peach-glow);'></i> A Candle is Lit";
            btn.style.borderColor = "var(--peach-glow)";
            btn.disabled = true;
        }

        function saveToCollection() {
            const btn = document.querySelector('.ritual-btn.save');
            btn.innerHTML = "<i class='fas fa-check'></i> Saved to 'My Letters'";
            btn.style.color = "var(--teal-glow)";
        }
    </script>

</body>

</html>