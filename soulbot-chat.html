<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" type="image/png" href="assets/images/favicon_symbol.png">
    <title>Chat with SoulBot | Soulamore</title>

    <!-- FONTS -->
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- GLOBAL THEME -->
    <link rel="stylesheet" href="assets/css/global.css">

    <style>
        /* --- CHAT SPECIFIC THEME OVERRIDES --- */
        body {
            /* Mobile Viewport Fix */
            height: 100dvh;
            overflow: hidden;
            /* Prevent body scroll, handle inside containers */
            display: flex;
            flex-direction: column;
            background: var(--body-bg, radial-gradient(circle at 50% 10%, #1e293b 0%, #0f172a 80%));
            transition: background 0.5s ease;
        }

        /* LIGHT MODE OVERRIDES */
        body.light-mode {
            background: radial-gradient(circle at 50% 10%, #f1f5f9 0%, #e2e8f0 80%) !important;
            color: #1e293b !important;
        }

        body.light-mode .chat-header {
            background: rgba(255, 255, 255, 0.8) !important;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1) !important;
        }

        body.light-mode .model-selector {
            color: #1e293b !important;
        }

        body.light-mode .sidebar {
            background: rgba(255, 255, 255, 0.95) !important;
            border-right: 1px solid rgba(0, 0, 0, 0.1) !important;
        }

        body.light-mode .new-chat-btn {
            background: rgba(0, 0, 0, 0.05) !important;
            border: 1px solid rgba(0, 0, 0, 0.1) !important;
            color: #334155 !important;
        }

        body.light-mode .history-item {
            color: #64748b !important;
        }

        body.light-mode .history-item:hover {
            background: rgba(0, 0, 0, 0.05) !important;
            color: #1e293b !important;
        }

        body.light-mode .chat-input-box {
            background: rgba(255, 255, 255, 0.9) !important;
            border: 1px solid rgba(0, 0, 0, 0.1) !important;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05) !important;
        }

        body.light-mode #userInput {
            color: #1e293b !important;
        }

        body.light-mode .prompt-card {
            background: rgba(255, 255, 255, 0.6) !important;
            border: 1px solid rgba(0, 0, 0, 0.1) !important;
            color: #475569 !important;
        }

        body.light-mode .prompt-card:hover {
            background: white !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05) !important;
        }

        body.light-mode .sidebar-footer {
            border-top: 1px solid rgba(0, 0, 0, 0.1) !important;
        }

        body.light-mode .msg-content {
            color: #334155 !important;
        }

        body.light-mode .user-avatar {
            background: #e2e8f0 !important;
            border: 1px solid #cbd5e1 !important;
            color: #64748b !important;
        }

        /* --- LAYOUT GRID --- */
        .chat-layout {
            display: flex;
            flex: 1;
            height: 100%;
            overflow: hidden;
            position: relative;
        }

        /* --- SIDEBAR (History) --- */
        .sidebar {
            width: 280px;
            background: rgba(0, 0, 0, 0.2);
            /* Transparent to show theme */
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--border-glass);
            display: flex;
            flex-direction: column;
            padding: 20px;
            z-index: 50;
            transition: transform 0.3s ease;
        }

        .new-chat-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-glass);
            color: var(--starlight);
            padding: 12px;
            border-radius: 12px;
            text-align: left;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95rem;
            margin-bottom: 20px;
        }

        .new-chat-btn:hover {
            background: rgba(78, 205, 196, 0.1);
            border-color: var(--teal-glow);
            color: var(--teal-glow);
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Outfit', sans-serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--starlight);
            margin-bottom: 25px;
            padding-left: 5px;
        }

        .sidebar-brand i {
            color: var(--teal-glow);
        }

        .sidebar-brand .beta-tag {
            font-size: 0.7rem;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 400;
            opacity: 0.7;
            margin-top: 4px;
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .history-item {
            padding: 10px 12px;
            border-radius: 8px;
            color: #94a3b8;
            font-size: 0.9rem;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: 0.2s;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.03);
            color: var(--starlight);
        }

        .sidebar-footer {
            border-top: 1px solid var(--border-glass);
            padding-top: 15px;
            font-size: 0.85rem;
            color: #64748b;
        }

        /* --- MAIN CHAT AREA --- */
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background: transparent;
        }

        /* HEADER (Mobile Toggle + Branding) */
        .chat-header {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            background: rgba(15, 23, 42, 0.5);
            backdrop-filter: blur(5px);
        }

        .model-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--starlight);
            font-family: 'Outfit', sans-serif;
            font-size: 1.1rem;
        }

        /* MESSAGES CONTAINER */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            scroll-behavior: smooth;
            padding-bottom: 40px;
            /* More bottom spacing */
        }

        /* EMPTY STATE (Soul Orb) */
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            opacity: 1;
            transition: opacity 0.5s;
            width: 100%;
            /* Force full width */
        }

        .empty-state.hidden {
            display: none;
            opacity: 0;
        }

        /* SOUL ORB ANIMATION */
        .soul-orb-container {
            width: 120px;
            height: 120px;
            position: relative;
            margin-bottom: 30px;
        }

        .soul-orb {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, var(--teal-glow), var(--deep-space));
            box-shadow: 0 0 60px rgba(78, 205, 196, 0.3);
            animation: breathe 6s ease-in-out infinite;
            position: relative;
            z-index: 10;
        }

        .soul-orb::after {
            content: '';
            position: absolute;
            inset: -10px;
            border-radius: 50%;
            border: 2px solid rgba(244, 159, 117, 0.3);
            /* Peach ring */
            animation: spinRing 10s linear infinite;
        }

        @keyframes breathe {

            0%,
            100% {
                transform: scale(1);
                box-shadow: 0 0 40px rgba(78, 205, 196, 0.3);
            }

            50% {
                transform: scale(1.1);
                box-shadow: 0 0 80px rgba(78, 205, 196, 0.5);
            }
        }

        @keyframes spinRing {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .starter-prompts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            width: 100%;
            max-width: 800px;
            margin: 40px auto 0 auto;
            /* Force Center */
        }

        .prompt-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-glass);
            padding: 15px 20px;
            border-radius: 16px;
            font-size: 0.9rem;
            color: #cbd5e1;
            cursor: pointer;
            transition: 0.2s;
            text-align: left;
        }

        .prompt-card:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-2px);
        }

        /* MESSAGE BUBBLES */
        .message-row {
            display: flex;
            gap: 15px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        .msg-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: 700;
        }

        .bot-avatar {
            background: linear-gradient(135deg, var(--teal-glow), #2a9d8f);
            color: #0f172a;
            box-shadow: 0 0 15px rgba(78, 205, 196, 0.3);
        }

        .user-avatar {
            background: var(--navy-glass);
            border: 1px solid var(--border-glass);
            color: #94a3b8;
        }

        .msg-content {
            flex: 1;
            font-size: 1rem;
            line-height: 1.6;
            color: var(--starlight);
            padding-top: 5px;
            /* Align with avatar */
        }

        .msg-content p {
            margin-bottom: 10px;
        }

        .msg-content p:last-child {
            margin-bottom: 0;
        }

        .bot-thinking {
            display: flex;
            gap: 5px;
            padding: 10px 0;
        }

        .dot {
            width: 8px;
            height: 8px;
            background: var(--teal-glow);
            border-radius: 50%;
            animation: pulseDot 1.4s infinite ease-in-out both;
        }

        .dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes pulseDot {

            0%,
            80%,
            100% {
                transform: scale(0);
                opacity: 0.5;
            }

            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* --- INPUT AREA --- */
        .input-wrapper {
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            position: relative;
        }

        .chat-bar-container {
            padding: 20px;
            background: transparent;
            /* Gradient fades in from body */
            z-index: 100;
        }

        .chat-input-box {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid var(--border-glass);
            border-radius: 26px;
            padding: 10px 15px 10px 20px;
            display: flex;
            align-items: flex-end;
            backdrop-filter: blur(10px);
            transition: 0.3s;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }

        .chat-input-box:focus-within {
            border-color: rgba(78, 205, 196, 0.5);
            background: rgba(30, 41, 59, 0.9);
            box-shadow: 0 5px 30px rgba(78, 205, 196, 0.1);
        }

        #userInput {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            font-family: inherit;
            font-size: 1rem;
            resize: none;
            max-height: 150px;
            padding: 10px 0;
            outline: none;
            line-height: 1.5;
        }

        .send-icon-btn {
            background: var(--starlight);
            color: var(--deep-space);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
            transition: 0.2s;
            font-size: 1rem;
        }

        .send-icon-btn:hover {
            transform: scale(1.05);
            background: var(--teal-glow);
        }

        .send-icon-btn:disabled {
            background: #475569;
            cursor: not-allowed;
            transform: none;
        }

        /* --- MOBILE RESPONSIVENESS --- */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                left: -280px;
                /* Hide by default */
                height: 100%;
                box-shadow: 5px 0 30px rgba(0, 0, 0, 0.5);
            }

            .sidebar.open {
                transform: translateX(280px);
            }

            .sidebar-overlay {
                position: absolute;
                inset: 0;
                background: rgba(0, 0, 0, 0.6);
                z-index: 40;
                display: none;
                backdrop-filter: blur(3px);
            }

            .sidebar-overlay.active {
                display: block;
            }

            .mobile-menu-btn {
                display: block !important;
            }

            .starter-prompts {
                grid-template-columns: 1fr;
            }

            /* Hide Header Branding when Sidebar is Open (Prevent Ghosting) */
            body.sidebar-open .chat-header .model-selector {
                opacity: 0;
                transition: opacity 0.2s;
            }
        }

        .mobile-menu-btn {
            display: none;
            background: transparent;
            border: none;
            color: #94a3b8;
            font-size: 1.2rem;
            cursor: pointer;
        }

        /* --- THEME PICKER --- */
        .theme-picker {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            background: rgba(15, 23, 42, 0.8);
            padding: 8px 12px;
            border-radius: 50px;
            border: 1px solid var(--border-glass);
            z-index: 200;
        }

        .theme-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: 0.2s;
        }

        .theme-dot:hover,
        .theme-dot.active {
            transform: scale(1.2);
            border-color: white;
        }
    </style>
</head>

<body>

    <div class="chat-layout">

        <!-- OVERLAY FOR MOBILE SIDEBAR -->
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

        <!-- SIDEBAR -->
        <aside class="sidebar" id="sidebar">
            <!-- BRANDING -->
            <div class="sidebar-brand">
                SoulBot <span class="beta-tag">Beta</span>
            </div>

            <div class="new-chat-btn" onclick="location.reload()">
                <i class="fas fa-plus"></i> New Chat
            </div>

            <div class="category-header" style="padding-left:0; margin-bottom:10px;">Today</div>
            <div class="history-list">
                <div class="history-item"><i class="far fa-comment-alt" style="margin-right:8px;"></i> Feeling
                    overwhelmed...</div>
                <div class="history-item"><i class="far fa-comment-alt" style="margin-right:8px;"></i> Advice on anxiety
                </div>
            </div>

            <div class="sidebar-footer">
                <div class="history-item" onclick="location.href='login.html'"
                    style="color:var(--teal-glow); font-weight:600;">
                    <i class="fas fa-sign-in-alt" style="margin-right:8px;"></i> Log In / Sign Up
                </div>
                <div class="history-item" onclick="location.href='index.html'">
                    <i class="fas fa-home" style="margin-right:8px;"></i> Back to Home
                </div>
                <div class="history-item" style="color:var(--peach-glow);">
                    <i class="fas fa-user-shield" style="margin-right:8px;"></i> Upgrade Plan
                </div>
            </div>
        </aside>

        <!-- MAIN CHAT -->
        <main class="main-chat">

            <!-- THEME TOGGLE -->
            <div class="theme-picker">
                <!-- TEAL (Default) uses a brighter center -->
                <div class="theme-dot active" style="background:#4ECDC4;"
                    onclick="setTheme('#4ECDC4', 'dark', 'radial-gradient(circle at 50% 0%, #115e59 0%, #0f172a 100%)')"
                    title="Deep Teal (Default)"></div>

                <!-- PASTELS (Brighter Backgrounds) -->
                <div class="theme-dot" style="background:#a78bfa;"
                    onclick="setTheme('#a78bfa', 'dark', 'radial-gradient(circle at 50% 0%, #5b21b6 0%, #0f172a 100%)')"
                    title="Lavender Dream"></div>

                <div class="theme-dot" style="background:#f472b6;"
                    onclick="setTheme('#f472b6', 'dark', 'radial-gradient(circle at 50% 0%, #be185d 0%, #0f172a 100%)')"
                    title="Rose Petal"></div>

                <div class="theme-dot" style="background:#fbbf24;"
                    onclick="setTheme('#fbbf24', 'dark', 'radial-gradient(circle at 50% 0%, #b45309 0%, #0f172a 100%)')"
                    title="Warm Amber"></div>

                <div class="theme-dot" style="background:#38bdf8;"
                    onclick="setTheme('#38bdf8', 'dark', 'radial-gradient(circle at 50% 0%, #0369a1 0%, #0f172a 100%)')"
                    title="Sky Serenity"></div>

                <!-- SPECIAL THEMES -->
                <div class="theme-dot" style="background:#ef4444;"
                    onclick="setTheme('#ef4444', 'dark', 'radial-gradient(circle at 50% 0%, #7f1d1d 0%, #000000 100%)')"
                    title="Midnight Inferno"></div>

                <div class="theme-dot" style="background:#ffffff; border:1px solid #ccc;"
                    onclick="setTheme('#0f766a', 'light', 'none')" title="Zen White"></div>
            </div>

            <script>
                function setTheme(accent, mode, bgGradient) {
                    // 1. Set Accent
                    document.documentElement.style.setProperty('--teal-glow', accent);

                    // 2. Set Background
                    if (mode === 'light') {
                        document.body.classList.add('light-mode');
                        document.body.style.background = ''; // Use CSS default for light mode
                        document.querySelector('.sidebar').style.background = 'rgba(255, 255, 255, 0.95)';
                    } else {
                        document.body.classList.remove('light-mode');
                        document.body.style.background = bgGradient;
                        // document.documentElement.style.setProperty('--body-bg', bgGradient);
                        document.querySelector('.sidebar').style.background = 'rgba(0, 0, 0, 0.2)';
                    }

                    // 3. Update Active Dot
                    document.querySelectorAll('.theme-dot').forEach(d => d.classList.remove('active'));
                    event.target.classList.add('active');

                    // 4. Persist
                    const config = { accent, mode, bgGradient };
                    localStorage.setItem('soulbotThemeConfig', JSON.stringify(config));
                }

                // INIT
                try {
                    const saved = JSON.parse(localStorage.getItem('soulbotThemeConfig'));
                    if (saved) {
                        // We can't pass event.target here, so we manually find the dot or just apply styles
                        document.documentElement.style.setProperty('--teal-glow', saved.accent);
                        if (saved.mode === 'light') {
                            document.body.classList.add('light-mode');
                        } else {
                            document.body.classList.remove('light-mode');
                            document.body.style.background = saved.bgGradient;
                        }
                    }
                } catch (e) { console.log('Theme Init Error', e); }
            </script>

            <!-- HEADER -->
            <header class="chat-header">
                <button class="mobile-menu-btn" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="model-selector">
                    <span style="color:var(--teal-glow);">SoulBot</span> <span
                        style="opacity:0.5; font-size:0.8rem; font-weight:400; background:rgba(255,255,255,0.1); padding:2px 8px; border-radius:12px;">Beta</span>
                </div>
                <div style="width:24px;"></div> <!-- Spacer for balance -->
            </header>

            <!-- MESSAGES -->
            <div class="messages-container" id="messagesContainer">

                <!-- EMPTY STATE -->
                <div class="empty-state" id="emptyState">
                    <div class="soul-orb-container">
                        <div class="soul-orb"></div>
                    </div>
                    <h2 style="font-family:'Outfit'; font-size:1.8rem; margin-bottom:10px;">How are you feeling today?
                    </h2>
                    <p style="color:#94a3b8; margin-bottom:30px;">I'm here to listen, reflect, and help you find
                        clarity.</p>

                    <div class="starter-prompts">
                        <div class="prompt-card" onclick="sendPrompt(this)">I feel overwhelmed with everything right
                            now.</div>
                        <div class="prompt-card" onclick="sendPrompt(this)">I can't sleep and my mind is racing.</div>
                        <div class="prompt-card" onclick="sendPrompt(this)">I just need to vent about my day.</div>
                        <div class="prompt-card" onclick="sendPrompt(this)">Help me practice a 5-minute breathing
                            exercise.</div>
                    </div>
                </div>

                <!-- DYNAMIC MESSAGES WILL APPEAR HERE -->

            </div>

            <!-- INPUT AREA -->
            <div class="chat-bar-container">
                <div class="input-wrapper">
                    <div class="chat-input-box">
                        <textarea id="userInput" placeholder="Message SoulBot..." rows="1" oninput="autoExpand(this)"
                            onkeydown="handleEnter(event)"></textarea>
                        <button class="send-icon-btn" id="sendBtn" onclick="handleSend()">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                    </div>
                    <div style="text-align:center; font-size:0.75rem; color:#64748b; margin-top:10px;">
                        SoulBot can make mistakes. Please verify important info. <a href="#"
                            style="color:#94a3b8; text-decoration:underline;">Safety Guidelines</a>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- LOGIC -->
    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        // CONFIG (Same as soulbot.html)
        const API_KEY = "AIzaSyB9kvOpy4Aam-quPhOOfrlUuZDzSeD-BCE";
        const genAI = new GoogleGenerativeAI(API_KEY);
        const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

        const SYSTEM_INSTRUCTION = `
            You are SoulBot, a calm, emotionally intelligent reflection companion by Soulamore.
            TONE: Calm, friend at 2 AM, short gentle responses (2-3 sentences).
            GOAL: Help user slow down. Validate feelings.
            CRITICAL: If suicide/self-harm mentioned, reply ONLY: "CRISIS_ALERT".
        `;

        let chatHistory = [];
        const messagesContainer = document.getElementById('messagesContainer');
        const emptyState = document.getElementById('emptyState');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');

        // --- UI FUNCTIONS ---

        window.toggleSidebar = function () {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');

            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');

            // Toggle body class to trigger CSS rule for hiding branding
            document.body.classList.toggle('sidebar-open');
        }

        window.autoExpand = function (field) {
            field.style.height = 'inherit';
            const computed = window.getComputedStyle(field);
            const height = parseInt(computed.getPropertyValue('border-top-width'), 10)
                + parseInt(computed.getPropertyValue('padding-top'), 10)
                + field.scrollHeight
                + parseInt(computed.getPropertyValue('padding-bottom'), 10)
                + parseInt(computed.getPropertyValue('border-bottom-width'), 10);
            field.style.height = Math.min(height, 200) + 'px';

            // Enable/Disable button
            sendBtn.disabled = field.value.trim() === "";
        }

        window.handleEnter = function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        }

        window.sendPrompt = function (el) {
            userInput.value = el.innerText;
            handleSend();
        }

        window.handleSend = async function () {
            const text = userInput.value.trim();
            if (!text) return;

            // UI Updates
            userInput.value = "";
            userInput.style.height = 'auto';
            emptyState.classList.add('hidden');

            appendMessage('user', text);

            // Add Thinking Placeholder
            const thinkingId = appendThinking();
            scrollToBottom();

            // API Logic
            try {
                // Safety Check First
                const crisisKeywords = ['suicide', 'kill myself', 'die', 'end it all'];
                if (crisisKeywords.some(w => text.toLowerCase().includes(w))) {
                    removeThinking(thinkingId);
                    appendCrisisCard();
                    return;
                }

                const chat = model.startChat({
                    history: [
                        { role: "user", parts: [{ text: SYSTEM_INSTRUCTION }] },
                        { role: "model", parts: [{ text: "Understood." }] },
                        ...chatHistory
                    ]
                });

                const result = await chat.sendMessage(text);
                const response = result.response.text();

                removeThinking(thinkingId);

                if (response.includes("CRISIS_ALERT")) {
                    appendCrisisCard();
                } else {
                    appendMessage('bot', response);
                    chatHistory.push({ role: "user", parts: [{ text: text }] });
                    chatHistory.push({ role: "model", parts: [{ text: response }] });
                }

            } catch (err) {
                removeThinking(thinkingId);
                appendMessage('bot', "I'm having a little trouble connecting. Please try again in a moment.");
                console.error(err);
            }
        }

        function appendMessage(role, text) {
            const div = document.createElement('div');
            div.className = 'message-row';

            const avatar = role === 'user'
                ? `<div class="msg-avatar user-avatar"><i class="fas fa-user"></i></div>`
                : `<div class="msg-avatar bot-avatar"><i class="fas fa-ghost"></i></div>`;

            div.innerHTML = `
                ${avatar}
                <div class="msg-content">
                    <div style="font-weight:700; font-size:0.9rem; margin-bottom:5px; color:${role === 'user' ? '#94a3b8' : 'var(--teal-glow)'}">${role === 'user' ? 'You' : 'SoulBot'}</div>
                    ${role === 'bot' ? formatText(text) : text}
                </div>
            `;
            messagesContainer.appendChild(div);
            scrollToBottom();
        }

        function appendThinking() {
            const id = 'thinking-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'message-row';
            div.innerHTML = `
                <div class="msg-avatar bot-avatar"><i class="fas fa-ghost"></i></div>
                <div class="msg-content">
                    <div class="bot-thinking">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(div);
            return id;
        }

        function removeThinking(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function appendCrisisCard() {
            const div = document.createElement('div');
            div.className = 'message-row';
            div.innerHTML = `
                <div class="msg-avatar bot-avatar" style="background:var(--alert-red); color:white;"><i class="fas fa-heart-broken"></i></div>
                <div class="msg-content">
                    <div style="background:rgba(239, 68, 68, 0.1); border:1px solid var(--alert-red); padding:20px; border-radius:12px; color:#fca5a5;">
                        <strong>I hear how much pain you are in.</strong><br>
                        Please, let's keep you safe.<br><br>
                        <a href="tel:14416" style="display:inline-block; background:var(--alert-red); color:white; padding:10px 20px; border-radius:30px; text-decoration:none; font-weight:700;">ðŸ“ž Call Tele-MANAS (14416)</a>
                    </div>
                </div>
            `;
            messagesContainer.appendChild(div);
            scrollToBottom();
        }

        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function formatText(text) {
            return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
        }

    </script>
</body>

</html>