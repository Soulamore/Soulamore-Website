<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <!-- AUTH GUARD: Protects this page -->
    <script src="../assets/js/auth-guard.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Space | Soulamore</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/global.css">
    <link rel="stylesheet" href="../assets/css/dashboard-sidebar.css">
    <style>
        /* --- DASHBOARD V3 RETRO-FIT --- */
        :root {
            /* Palette from Screenshots */
            --bg-deep: #0f172a;
            /* Main Background */
            --bg-card: #1e293b;
            /* Card Background */
            --bg-sidebar: #0f172a;
            /* Sidebar matches body */
            --teal-accent: #2dd4bf;
            /* The "SoulBot" Teal */
            --teal-dim: rgba(45, 212, 191, 0.1);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border-subtle: rgba(255, 255, 255, 0.08);
            --font-head: 'Outfit', sans-serif;
            --font-body: 'Plus Jakarta Sans', sans-serif;
        }

        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: var(--font-body);
            overflow-x: hidden;
            /* Prevent horizontal scroll */
        }

        /* --- LAYOUT --- */
        .dashboard-layout {
            display: flex;
            min-height: 100vh;
        }

        /* --- SIDEBAR (Updated to match image) --- */
        .sidebar {
            width: 260px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-subtle);
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 40px;
            padding-left: 10px;
        }

        .user-avatar-lg {
            width: 48px;
            height: 48px;
            background: var(--bg-card);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-main);
            font-size: 1.2rem;
            border: 1px solid var(--border-subtle);
        }

        .user-info-text .name {
            font-family: var(--font-head);
            font-weight: 700;
            font-size: 1rem;
            line-height: 1.2;
        }

        .user-info-text .role {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex: 1;
        }

        .side-link {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 20px;
            color: var(--text-muted);
            text-decoration: none;
            border-radius: 12px;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .side-link i {
            width: 20px;
            text-align: center;
        }

        .side-link:hover {
            color: var(--text-main);
            background: rgba(255, 255, 255, 0.03);
        }

        .side-link.active {
            background: rgba(45, 212, 191, 0.15);
            /* Teal Tint */
            color: var(--teal-accent);
            font-weight: 600;
            position: relative;
        }

        /* Active Indicator Line (Optional, simplified to pill for now) */

        .logout-section {
            padding-top: 20px;
            border-top: 1px solid var(--border-subtle);
        }

        /* --- MAIN CONTENT AREA --- */
        main {
            flex: 1;
            margin-left: 260px;
            /* Sidebar Width */
            padding: 40px 60px;
            max-width: 1400px;
            /* No Center constraint, let grid handle it */
        }

        /* --- CARDS & PANELS --- */
        .dash-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 24px;
            /* Matches screenshot roundedness */
            padding: 30px;
            margin-bottom: 25px;
            transition: transform 0.2s ease, border-color 0.2s ease;
        }

        .dash-card:hover {
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* --- TYPOGRAPHY UPDATES --- */
        h1,
        h2,
        h3,
        h4 {
            font-family: var(--font-head);
            color: var(--text-main);
        }

        /* --- BUTTONS (The TEAL!) --- */
        .btn-dash-primary {
            background: var(--teal-accent);
            color: #0f172a;
            /* Dark Text on Teal */
            font-weight: 700;
            font-family: var(--font-head);
            padding: 14px 32px;
            border-radius: 50px;
            /* Pill Shape */
            border: none;
            cursor: pointer;
            font-size: 1rem;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(45, 212, 191, 0.3);
            text-transform: none;
        }

        .btn-dash-primary:hover {
            background: #20b2aa;
            /* Slightly darker teal */
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(45, 212, 191, 0.4);
        }

        .btn-dash-secondary {
            background: transparent;
            color: var(--text-main);
            border: 1px solid var(--border-subtle);
            padding: 12px 28px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: var(--font-body);
        }

        .btn-dash-secondary:hover {
            border-color: var(--text-muted);
            background: rgba(255, 255, 255, 0.05);
        }

        /* --- SPECIFIC VIEWS (Home Hero) --- */
        #view-home h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        /* SoulBot Hero Card specific overrides to match image */
        .soulbot-hero {
            text-align: center;
            padding: 60px 40px !important;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .soulbot-hero i {
            font-size: 4rem !important;
            color: var(--teal-accent) !important;
            margin-bottom: 25px !important;
            filter: drop-shadow(0 0 15px rgba(45, 212, 191, 0.4));
        }

        /* --- CHAT BUBBLES --- */
        .chat-bubble {
            max-width: 80%;
            padding: 15px 20px;
            border-radius: 18px;
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .chat-bubble.bot {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-subtle);
            color: var(--text-main);
            border-bottom-left-radius: 4px;
        }

        .chat-bubble.user {
            background: var(--teal-accent);
            color: #0f172a;
            align-self: flex-end;
            /* Needs flex col parent */
            border-bottom-right-radius: 4px;
            font-weight: 500;
        }

        /* --- RESPONSIVE --- */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                /* Hidden by default */
            }

            .sidebar.open {
                transform: translateX(0);
            }

            main {
                margin-left: 0;
                padding: 20px;
            }

            .mobile-toggle {
                display: block;
                /* Ensure visible */
                position: fixed;
                top: 20px;
                left: 20px;
                z-index: 1001;
                background: var(--bg-card);
                border: 1px solid var(--border-subtle);
                color: var(--text-main);
                padding: 10px;
                border-radius: 8px;
            }
        }

        /* --- FINAL POLISH (Footer & Inputs) --- */
        .sidebar-footer {
            margin-top: auto;
            border-top: 1px solid var(--border-subtle);
            padding-top: 20px;
        }

        .logout-btn {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            /* Red for logout */
            border: 1px solid rgba(239, 68, 68, 0.2);
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: 600;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        /* Settings Pills */
        .theme-btn,
        .theme-tag {
            background: var(--bg-deep);
            border: 1px solid var(--border-subtle);
            color: var(--text-muted);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: 0.2s;
        }

        .theme-btn.active,
        .theme-tag.active {
            background: var(--teal-accent);
            color: #0f172a;
            border-color: var(--teal-accent);
            font-weight: 700;
        }

        /* Form Inputs */
        input[type="text"],
        input[type="email"],
        input[type="tel"],
        textarea {
            background: var(--bg-deep) !important;
            border: 1px solid var(--border-subtle) !important;
            color: var(--text-main) !important;
            border-radius: 12px !important;
            padding: 12px 15px !important;
            outline: none;
            transition: border-color 0.2s;
        }

        input:focus,
        textarea:focus {
            border-color: var(--teal-accent) !important;
        }
    </style>
</head>

<body>

    <!-- TOOL MODAL CONTAINER -->
    <div id="toolModal" class="tool-modal-overlay">
        <div class="tool-modal-content">
            <div class="tool-modal-header">
                <div class="tool-modal-title" id="modalTitle">Tool Name</div>
                <button class="tool-close-btn" onclick="closeTool()"><i class="fas fa-times"></i></button>
            </div>
            <iframe id="toolFrame" class="tool-frame" src=""></iframe>
        </div>
    </div>

    <!-- MOBILE TOGGLE -->
    <button class="mobile-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <div class="dashboard-layout">

        <!-- SIDEBAR -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="user-avatar-lg">
                    <i class="fas fa-user-astronaut"></i>
                </div>
                <div class="user-info-text">
                    <div class="name" id="sidebar-name">Loading...</div>
                    <div class="role" id="sidebar-role">Member</div>
                </div>
            </div>

            <div class="sidebar-nav">
                <a href="#" class="side-link active" onclick="switchView('home', this)" data-view="home"><i
                        class="fas fa-home"></i> <span>Home</span></a>
                <a href="#" class="side-link" onclick="switchView('journal', this)" data-view="journal"><i
                        class="fas fa-book"></i> <span>My Journal</span></a>
                <a href="#" class="side-link" onclick="switchView('bookings', this)" data-view="bookings"><i
                        class="fas fa-calendar-alt"></i> <span>My Sessions</span></a>
                <a href="#" class="side-link" onclick="switchView('soulbot', this)" data-view="soulbot"><i
                        class="fas fa-robot"></i> <span>SoulBot AI</span></a>
                <a href="messaging.html" class="side-link"><i class="fas fa-envelope"></i> <span>Messages</span></a>
                <a href="#" onclick="switchView('saved', this)" class="side-link"><i class="fas fa-bookmark"></i>
                    <span>Saved</span></a>

                <hr style="border:0; border-top:1px solid rgba(255,255,255,0.05); margin:10px 0;">
                <a href="#" class="side-link" onclick="switchView('settings', this)" data-view="settings"><i
                        class="fas fa-cog"></i> <span>Settings</span></a>
            </div>

            <div class="sidebar-footer">
                <button class="logout-btn" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> Log Out</button>
            </div>
        </nav>

        <!-- MAIN CONTENT -->
        <main class="main-content fade-in">

            <!-- VIEW: SETTINGS (Appearance & Preferences) -->
            <div id="view-settings" class="view-section" style="display:none;">
                <h2 style="font-family:'Outfit'; font-size:2rem; margin-bottom:10px;">Settings</h2>
                <p style="opacity:0.7; margin-bottom:40px;">Customize your space to feel right for you.</p>

                <div class="dashboard-grid" style="grid-template-columns: 1fr;">

                    <!-- APPEARANCE CARD -->
                    <div class="dash-card">
                        <h3 style="margin-bottom:20px;">Appearance & Atmosphere</h3>

                        <!-- Mode (Light/Dark) -->
                        <div style="margin-bottom:30px;">
                            <label style="display:block; margin-bottom:15px; font-weight:600; opacity:0.9;">Lighting
                                Mode</label>
                            <div style="display:flex; gap:15px;">
                                <button onclick="setThemeMode('dark')" class="theme-btn active" id="btn-mode-dark">
                                    <i class="fas fa-moon"></i> Dark
                                </button>
                                <button onclick="setThemeMode('light')" class="theme-btn" id="btn-mode-light">
                                    <i class="fas fa-sun"></i> Light
                                </button>
                            </div>
                        </div>

                        <!-- Emotional Theme -->
                        <div style="margin-bottom:30px;">
                            <label style="display:block; margin-bottom:15px; font-weight:600; opacity:0.9;">Emotional
                                Theme</label>
                            <div style="display:flex; flex-wrap:wrap; gap:10px;">
                                <button onclick="setEmotionalTheme('calm')" class="theme-tag active"
                                    id="btn-theme-calm">üåä Calm (Default)</button>
                                <button onclick="setEmotionalTheme('neutral')" class="theme-tag"
                                    id="btn-theme-neutral">üå´ Neutral</button>
                                <button onclick="setEmotionalTheme('grounded')" class="theme-tag"
                                    id="btn-theme-grounded">üå± Grounded</button>
                                <button onclick="setEmotionalTheme('warm')" class="theme-tag" id="btn-theme-warm">‚òÄÔ∏è
                                    Warm</button>
                                <button onclick="setEmotionalTheme('focus')" class="theme-tag" id="btn-theme-focus">üéØ
                                    Focus</button>
                            </div>
                            <p style="font-size:0.85rem; opacity:0.6; margin-top:15px;">
                                * Calm: Safety & Night Use | Neutral: Low Stimulation | Grounded: Stability | Warm:
                                Encouragement | Focus: Clarity
                            </p>
                        </div>
                    </div>

                    <!-- ACCOUNT / PROFILE SECTION -->
                    <div class="dash-card">
                        <h3 style="margin-bottom:20px;">My Profile & Security</h3>

                        <!-- Personal Details -->
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
                            <div>
                                <label style="display:block; font-size:0.85rem; opacity:0.7; margin-bottom:8px;">Full
                                    Name</label>
                                <input type="text" id="profile-name" value="Loading..."
                                    style="width:100%; padding:12px; background:var(--bg-primary); border:1px solid var(--border-soft); border-radius:10px; color:var(--text-primary); outline:none;">
                            </div>
                            <div>
                                <label style="display:block; font-size:0.85rem; opacity:0.7; margin-bottom:8px;">Phone
                                    Number</label>
                                <input type="tel" id="profile-phone" value="" placeholder="Add phone number"
                                    style="width:100%; padding:12px; background:var(--bg-primary); border:1px solid var(--border-soft); border-radius:10px; color:var(--text-primary); outline:none;">
                            </div>
                        </div>

                        <!-- Login Info (Read Only) -->
                        <div style="margin-bottom:25px;">
                            <label style="display:block; font-size:0.85rem; opacity:0.7; margin-bottom:8px;">Login
                                Method</label>
                            <div
                                style="display:flex; align-items:center; gap:10px; padding:12px; background:rgba(255,255,255,0.03); border:1px solid var(--border-soft); border-radius:10px;">
                                <i class="fab fa-google" style="color:var(--text-secondary);"></i>
                                <span id="profile-email"
                                    style="flex:1; color:var(--text-secondary); opacity:0.8;">loading...</span>
                                <span id="profile-verified"
                                    style="font-size:0.8rem; padding:2px 8px; background:var(--bg-elevated); border-radius:4px; opacity:0.6;">Verified</span>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div style="display:flex; gap:15px; border-top:1px solid var(--border-soft); padding-top:20px;">
                            <button class="btn-dash-primary" style="padding:10px 25px; font-size:0.95rem;">Save
                                Changes</button>
                            <button class="btn-dash-secondary"
                                onclick="alert('Password reset link sent to email.')">Change Password</button>
                        </div>
                    </div>

                </div>
            </div>

            <!-- VIEW: SOULBOT CHAT -->
            <div id="view-soulbot" class="view-section" style="display:none;">
                <div class="soulbot-layout"
                    style="display:grid; grid-template-columns: 1fr 300px; gap:20px; height:calc(100vh - 120px);">

                    <!-- CHAT AREA -->
                    <div class="dash-card link-hover"
                        style="display:flex; flex-direction:column; padding:0; overflow:hidden;">
                        <!-- Header -->
                        <div
                            style="padding:20px; border-bottom:1px solid rgba(255,255,255,0.05); display:flex; justify-content:space-between; align-items:center; background:rgba(0,0,0,0.2);">
                            <div style="display:flex; gap:15px; align-items:center;">
                                <div
                                    style="width:40px; height:40px; background:var(--teal-glow); border-radius:50%; display:flex; align-items:center; justify-content:center; color:#0f172a; font-size:1.2rem;">
                                    <i class="fas fa-robot"></i>
                                </div>
                                <div>
                                    <div style="font-family:'Outfit'; font-weight:700; font-size:1.1rem;">SoulBot AI
                                    </div>
                                    <div style="font-size:0.8rem; opacity:0.7; color:#22c55e;"><i class="fas fa-circle"
                                            style="font-size:0.5rem; vertical-align:middle;"></i> Online & Ready to
                                        Listen</div>
                                </div>
                            </div>
                            <button onclick="clearChat()"
                                style="background:transparent; border:1px solid rgba(255,255,255,0.1); color:white; padding:5px 15px; border-radius:20px; font-size:0.8rem; cursor:pointer; opacity:0.7;">
                                <i class="fas fa-trash-alt"></i> Clear Chat
                            </button>
                        </div>

                        <!-- Messages -->
                        <div id="soulbot-messages"
                            style="flex:1; padding:20px; overflow-y:auto; display:flex; flex-direction:column; gap:15px;">
                            <!-- Welcome Msg -->
                            <div class="chat-bubble bot">
                                Hi there. I'm SoulBot. I'm not a therapist, but I'm here to listen without judgment.
                                What's on your mind today?
                            </div>
                        </div>

                        <!-- Input -->
                        <div
                            style="padding:20px; background:rgba(0,0,0,0.2); border-top:1px solid rgba(255,255,255,0.05); display:flex; gap:10px;">
                            <input type="text" id="soulbot-input" placeholder="Type your message..."
                                style="flex:1; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); padding:12px 15px; border-radius:12px; color:white; outline:none;">
                            <button onclick="sendMessage()"
                                style="background:var(--teal-glow); color:#0f172a; border:none; width:45px; height:45px; border-radius:12px; font-size:1.1rem; cursor:pointer;">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>

                    <!-- HISTORY SIDEBAR -->
                    <div style="display:flex; flex-direction:column; gap:20px;">
                        <div class="dash-card" style="flex:1; display:flex; flex-direction:column;">
                            <h3 style="margin-bottom:15px; font-size:1.1rem;">Past Conversations</h3>
                            <div style="flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:10px;">
                                <div
                                    style="padding:10px; background:rgba(255,255,255,0.05); border-radius:8px; cursor:pointer; border-left:2px solid var(--teal-glow);">
                                    <div style="font-size:0.9rem; font-weight:600;">Anxiety about exams</div>
                                    <div style="font-size:0.8rem; opacity:0.6;">Yesterday</div>
                                </div>
                                <div
                                    style="padding:10px; background:transparent; border:1px solid rgba(255,255,255,0.05); border-radius:8px; cursor:pointer; opacity:0.7;">
                                    <div style="font-size:0.9rem; font-weight:600;">Feeling lonely</div>
                                    <div style="font-size:0.8rem; opacity:0.6;">3 days ago</div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- VIEW: HOME (The Quiet Room) -->
            <div id="view-home" class="view-section">

                <!-- LAYER 1: GROUNDING & PRIMARY ACTION -->
                <div style="text-align:center; padding:40px 0 60px;">
                    <h1 id="welcome-greeting"
                        style="font-family:var(--font-heading); font-size:2rem; margin-bottom:10px;">Welcome back.</h1>
                    <p style="opacity:0.8; font-size:1.1rem; margin-bottom:10px; color:var(--text-secondary);">Take a
                        deep breath. You are safe here.</p>
                    <p style="font-size:0.9rem; margin-bottom:40px; color:var(--text-muted); font-style:italic;">You can
                        move at your own pace.</p>

                    <!-- Primary Anchor: SoulBot -->
                    <div class="dash-card soulbot-hero">
                        <i class="fas fa-robot"></i>
                        <h2 style="font-size:1.5rem; margin-bottom:10px;">SoulBot is here with you.</h2>
                        <p style="opacity:0.8; margin-bottom:30px; color:var(--text-muted); max-width: 400px;">Start
                            where you are. We'll figure out the rest together.</p>
                        <button onclick="switchView('soulbot', null)" class="btn-dash-primary">
                            Continue with SoulBot
                        </button>
                    </div>
                </div>

                <!-- LAYER 2: REFLECTION (Secondary) -->
                <div style="max-width:700px; margin:0 auto 40px;">
                    <div class="dash-card link-hover"
                        style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <h3 style="font-size:1.2rem; margin-bottom:5px;">Your Journal</h3>
                            <p style="font-size:0.95rem; opacity:0.6; color:var(--text-muted);">Write or continue your
                                reflection.</p>
                        </div>
                        <button onclick="switchView('journal', null)" class="btn-dash-secondary">
                            Open Journal
                        </button>
                    </div>
                </div>

                <!-- LAYER 3: HUMAN SUPPORT (When ready) -->
                <div style="max-width:600px; margin:0 auto; text-align:center;">
                    <div
                        style="font-size:0.9rem; opacity:0.5; margin-bottom:20px; text-transform:uppercase; letter-spacing:1px; font-weight:700;">
                        When you want to talk to someone</div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <!-- Peer -->
                        <div class="dash-card link-hover card-peer"
                            onclick="window.location.href='../our-peers/about.html'"
                            style="text-align:center; cursor:pointer; display:flex; flex-direction:column; align-items:center;">
                            <i class="fas fa-hands-helping"
                                style="font-size:2rem; color:var(--peach-glow); margin-bottom:15px;"></i>
                            <h4 style="margin-bottom:5px;">Talk to a Peer</h4>
                            <p style="font-size:0.8rem; opacity:0.6;">Someone who gets it.</p>
                        </div>

                        <!-- Pro -->
                        <div class="dash-card link-hover card-pro"
                            onclick="window.location.href='../our-psychologists/about.html'"
                            style="text-align:center; cursor:pointer; display:flex; flex-direction:column; align-items:center;">
                            <i class="fas fa-user-md"
                                style="font-size:2rem; color:var(--teal-accent); margin-bottom:15px;"></i>
                            <h4 style="margin-bottom:5px;">Professional Help</h4>
                            <p style="font-size:0.8rem; opacity:0.6;">Guidance & Therapy.</p>
                        </div>
                    </div>
                </div>

            </div>

            <!-- VIEW: BOOKINGS (Enhanced) -->
            <div id="view-bookings" class="view-section" style="display:none;">
                <h2 style="margin-bottom:10px;">My Sessions</h2>
                <p style="opacity:0.7; margin-bottom:30px;">Manage your appointments with Peers and Psychologists.</p>

                <!-- TABS -->
                <div
                    style="display:flex; gap:20px; border-bottom:1px solid var(--border-soft); margin-bottom:30px; padding-bottom:10px;">
                    <div
                        style="font-weight:700; color:var(--accent-primary); border-bottom:2px solid var(--accent-primary); padding-bottom:10px; cursor:pointer;">
                        Upcoming</div>
                    <div style="opacity:0.6; cursor:pointer;">History</div>
                    <div style="opacity:0.6; cursor:pointer;">Feedback</div>
                </div>

                <div class="dashboard-grid">
                    <!-- MAIN LIST -->
                    <div class="dash-card" style="grid-column: span 1;">
                        <h3 style="margin-bottom:20px;">Upcoming Sessions</h3>

                        <!-- Empty State Placeholder -->
                        <div
                            style="text-align:center; padding:40px; background:var(--bg-primary); border-radius:12px; border:1px dashed var(--border-soft);">
                            <i class="fas fa-calendar-check"
                                style="font-size:2rem; opacity:0.3; margin-bottom:15px;"></i>
                            <p style="opacity:0.7;">No upcoming sessions scheduled.</p>
                            <button onclick="window.location.href='../our-peers/about.html'" class="btn-dash-primary"
                                style="margin-top:10px; font-size:0.9rem; padding:10px 25px;">Book a Session</button>
                        </div>
                    </div>

                    <!-- SIDEBAR: FIND HELP -->
                    <div style="display:flex; flex-direction:column; gap:20px;">
                        <!-- Book New -->
                        <div class="dash-card">
                            <h4 style="margin-bottom:15px;">Find Support</h4>
                            <div onclick="openTool('../our-peers/index.html', 'Browse Peers')" class="action-row peach">
                                <div
                                    style="width:35px; height:35px; background:rgba(244, 159, 117, 0.1); border-radius:50%; display:flex; align-items:center; justify-content:center; color:var(--accent-secondary);">
                                    <i class="fas fa-hands-helping"></i>
                                </div>
                                <div style="font-size:0.9rem;">Browse Peer Listeners</div>
                            </div>
                            <div onclick="openTool('../our-psychologists/psychologists.html', 'Browse Psychologists')"
                                class="action-row">
                                <div
                                    style="width:35px; height:35px; background:rgba(78, 205, 196, 0.1); border-radius:50%; display:flex; align-items:center; justify-content:center; color:var(--accent-primary);">
                                    <i class="fas fa-user-md"></i>
                                </div>
                                <div style="font-size:0.9rem;">Find a Psychologist</div>
                            </div>
                            <div onclick="window.open('https://www.supersaas.com/', '_blank')" class="action-row">
                                <div
                                    style="width:35px; height:35px; background:rgba(255,255,255,0.05); border-radius:50%; display:flex; align-items:center; justify-content:center;">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                                <div style="font-size:0.9rem;">SuperSaaS Calendar</div>
                            </div>
                        </div>

                        <!-- Credits -->
                        <div class="dash-card" style="position:relative; overflow:hidden;">
                            <h4 style="margin-bottom:5px;">Wallet</h4>
                            <div style="font-size:2rem; font-weight:700; color:var(--text-primary);">$0.00</div>
                            <div style="font-size:0.8rem; opacity:0.6; margin-bottom:15px;">Available Credits</div>
                            <button
                                style="width:100%; padding:10px; background:var(--bg-elevated); border:1px solid var(--border-soft); color:var(--text-primary); border-radius:8px; cursor:pointer;">Add
                                Funds</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: JOURNAL (New) -->
            <div id="view-journal" class="view-section" style="display:none;">
                <div style="display:grid; grid-template-columns: 250px 1fr; gap:20px; height:calc(100vh - 120px);">
                    <!-- Sidebar -->
                    <div class="dash-card" style="padding:15px; display:flex; flex-direction:column;">
                        <button
                            style="width:100%; padding:12px; background:var(--accent-primary); color:#0f172a; border:none; border-radius:8px; font-weight:700; cursor:pointer; margin-bottom:20px;"><i
                                class="fas fa-plus"></i> New Entry</button>
                        <div
                            style="font-size:0.8rem; opacity:0.6; text-transform:uppercase; margin-bottom:10px; font-weight:700;">
                            Recent</div>

                        <!-- DYNAMIC LIST CONTAINER -->
                        <div id="journal-list"
                            style="flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:5px;">
                            <!-- Injected via JS -->
                        </div>

                        <!-- EMPTY STATE -->
                        <div id="journal-empty" style="text-align:center; padding:20px; opacity:0.6; display:none;">
                            <i class="fas fa-pen-fancy" style="margin-bottom:10px;"></i>
                            <div style="font-size:0.8rem;">No entries yet.</div>
                        </div>
                    </div>

                    <!-- Editor -->
                    <div class="dash-card" style="display:flex; flex-direction:column; padding:30px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                            <input type="text" value="Morning Thoughts"
                                style="background:transparent; border:none; font-size:1.5rem; font-family:var(--font-heading); color:var(--text-primary); width:100%; outline:none;">
                            <div style="opacity:0.5; font-size:0.9rem;">Saved</div>
                        </div>
                        <textarea
                            style="flex:1; background:transparent; border:none; resize:none; font-family:var(--font-body); font-size:1.1rem; line-height:1.6; color:var(--text-secondary); outline:none;"
                            placeholder="Start writing..."></textarea>
                    </div>
                </div>
            </div>

            <!-- VIEW: SAVED CONTENT -->
            <div id="view-saved" class="view-section" style="display:none;">
                <h2 style="margin-bottom:30px;">Saved for Later</h2>
                <div class="dash-card">
                    <div style="display:flex; gap:10px; margin-bottom:20px;">
                        <button
                            style="padding:8px 15px; background:white; color:#0f172a; border-radius:30px; border:none; font-weight:700;">All</button>
                        <button
                            style="padding:8px 15px; background:rgba(255,255,255,0.05); color:white; border-radius:30px; border:none;">Articles</button>
                        <button
                            style="padding:8px 15px; background:rgba(255,255,255,0.05); color:white; border-radius:30px; border:none;">Forum
                            Posts</button>
                    </div>

                    <div style="display:flex; flex-direction:column; gap:15px;">
                        <div
                            style="background:rgba(255,255,255,0.03); padding:20px; border-radius:12px; display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <div style="font-weight:700; margin-bottom:5px;">Understanding Anxiety Triggers</div>
                                <div style="font-size:0.8rem; opacity:0.6;">Saved 2 days ago ‚Ä¢ Blog</div>
                            </div>
                            <button
                                style="background:transparent; border:1px solid rgba(255,255,255,0.1); color:white; padding:5px 15px; border-radius:4px;">Read</button>
                        </div>
                        <div
                            style="background:rgba(255,255,255,0.03); padding:20px; border-radius:12px; display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <div style="font-weight:700; margin-bottom:5px;">"How do you handle exam stress?"</div>
                                <div style="font-size:0.8rem; opacity:0.6;">Saved 5 hours ago ‚Ä¢ Forum ‚Ä¢ 12 new replies
                                </div>
                            </div>
                            <button
                                style="background:transparent; border:1px solid rgba(255,255,255,0.1); color:white; padding:5px 15px; border-radius:4px;">View
                                Thread</button>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- SCRIPTS -->
    <script src="../assets/js/components.js?v=3" onerror="console.error('Failed to load components.js')"></script>
    <script>
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
        function handleLogout() { sessionStorage.clear(); window.location.href = 'logout.html'; }

        // --- VIEW SWITCHING ---
        function switchView(viewName, clickedLink) {
            // Hide all view sections
            document.querySelectorAll('.view-section').forEach(el => el.style.display = 'none');
            // Show the target view section
            document.getElementById('view-' + viewName).style.display = 'block';

            // Update Sidebar Active State
            document.querySelectorAll('.sidebar-nav .side-link').forEach(l => l.classList.remove('active'));
            if (clickedLink) {
                clickedLink.classList.add('active');
            } else {
                // Fallback if clickedLink is not passed (e.g., initial load)
                const defaultLink = document.querySelector(`.sidebar-nav .side-link[data-view="${viewName}"]`);
                if (defaultLink) defaultLink.classList.add('active');
            }
        }

        // Initial view load function to check URL parameters or default
        document.addEventListener('DOMContentLoaded', () => {
            // Check if there is a 'view' query param, otherwise default to home
            // For now just defaulting to home, but logic is easy to extend
            // Also restore selected theme
            switchView('home');
        });

        // --- MODAL LOGIC ---
        function openTool(url, title) {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('toolFrame').src = url;
            document.getElementById('toolModal').classList.add('open');
        }
        function closeTool() {
            document.getElementById('toolModal').classList.remove('open');
            // Reset src to stop videos/audio
            setTimeout(() => { document.getElementById('toolFrame').src = ''; }, 300);
        }

        // --- MOOD LOGIC ---
        function logMood(mood) {
            alert(`Mood tracked: ${mood}. This would be saved to your private journal.`);
        }

        // Initialize View
        document.addEventListener('DOMContentLoaded', () => {
            // Just default to home, theme is handled by components.js
            switchView('home');
        });


        /* SOULBOT CHAT LOGIC - Deprecated (Handled by Module below) */
        // kept empty to avoid reference errors if any onclicks linger, 
        // though module overwrites window.sendMessage.


        // Allow Enter Key
        document.getElementById("soulbot-input").addEventListener("keypress", function (e) {
            if (e.key === "Enter") sendMessage();
        });

        // Initialize View with Deep Linking
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Check for URL Param ?view=xxx
            const urlParams = new URLSearchParams(window.location.search);
            const viewParam = urlParams.get('view');

            if (viewParam) {
                switchView(viewParam);
            } else {
                switchView('home');
            }

            // --- JOURNAL LOGIC (Added for Empty State Demo) ---
            renderJournalSidebar();
        });

        function renderJournalSidebar() {
            const list = document.getElementById('journal-list');
            const empty = document.getElementById('journal-empty');
            // Mock Data or LocalStorage
            const stored = localStorage.getItem('my_journal_entries');
            // Default demo data if nothing stored, to show UI
            const entries = stored ? JSON.parse(stored) : [
                { title: "Morning Thoughts", date: "Today" },
                { title: "Weekly Reflection", date: "3 days ago" }
            ];

            // To test empty state, uncomment:
            // const entries = [];

            if (!entries || entries.length === 0) {
                list.style.display = 'none';
                empty.style.display = 'block';
            } else {
                list.style.display = 'flex';
                empty.style.display = 'none';
                list.innerHTML = '';
                entries.forEach(e => {
                    const div = document.createElement('div');
                    div.style.cssText = "padding:10px; background:rgba(255,255,255,0.05); border-radius:6px; font-size:0.9rem; cursor:pointer; margin-bottom:5px;";
                    div.innerHTML = `${e.title} <br><span style="font-size:0.7em; opacity:0.5;">${e.date}</span>`;
                    list.appendChild(div);
                });
            }
        }
    </script>
    <script type="module">
        import { createConversation, addMessageToConversation, subscribeToConversation } from "../assets/js/soulbot-handler.js";

        let currentConversationId = localStorage.getItem('soulbot_conversation_id');
        let unsubscribe = null;
        const msgContainer = document.getElementById('soulbot-messages');
        const inputField = document.getElementById('soulbot-input');

        // --- INITIALIZATION ---
        async function initSoulBotChat() {
            if (!currentConversationId) {
                // Create new conversation
                // TODO: Pass actual userId if logged in
                currentConversationId = await createConversation("anonymous_user");
                if (currentConversationId) {
                    localStorage.setItem('soulbot_conversation_id', currentConversationId);
                }
            }

            // Subscribe to updates
            if (currentConversationId) {
                if (unsubscribe) unsubscribe(); // Clear old sub if any
                unsubscribe = subscribeToConversation(currentConversationId, renderMessages);
            }
        }

        // --- RENDER LOGIC ---
        function renderMessages(conversationData) {
            if (!conversationData || !conversationData.messages) return;

            // Clear current (simple re-render for MVP)
            msgContainer.innerHTML = '';

            // Add Welcome Message Always
            if (conversationData.messages.length === 0) {
                msgContainer.innerHTML = `
                    <div class="chat-bubble bot">
                        Hi there. I'm SoulBot. I'm not a therapist, but I'm here to listen without judgment.
                        What's on your mind today?
                    </div>`;
            }

            conversationData.messages.forEach(msg => {
                const div = document.createElement('div');
                div.className = `chat-bubble ${msg.role === 'user' ? 'user' : 'bot'}`;
                // Simple text rendering (could add markdown support later)
                div.innerText = msg.text;
                msgContainer.appendChild(div);
            });

            // Scroll to bottom
            msgContainer.scrollTop = msgContainer.scrollHeight;
        }

        // --- GLOBAL ACTIONS (Expose to window for onclick) ---
        window.sendMessage = async function () {
            const text = inputField.value.trim();
            if (!text) return;

            // UI: Clear immediately for responsiveness
            inputField.value = '';

            // Core: Send to Backend
            if (currentConversationId) {
                await addMessageToConversation(currentConversationId, 'user', text);

                // Mock Bot Reply (Temporary until Cloud Function/Backend Service is active)
                // In a real app, a Cloud Function triggers on Firestore write.
                // Here we simulate it locally for demonstration if needed, 
                // BUT the robust way is backend. 
                // For now, let's let the user know if no backend is responding.
                // setTimeout(() => addMessageToConversation(currentConversationId, 'bot', "I hear you. (AI Backend Integration required for full reply)"), 1000);
            }
        };

        window.clearChat = function () {
            if (confirm("Start a new conversation?")) {
                localStorage.removeItem('soulbot_conversation_id');
                currentConversationId = null;
                initSoulBotChat();
            }
        };

        // --- EVENT LISTENERS ---
        inputField.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') window.sendMessage();
        });

        // Start
        initSoulBotChat();
    </script>

    <!-- DASHBOARD HYDRATION SCRIPT -->
    <script type="module">
        import { onAuthChange } from "../assets/js/auth-service.js";
        import { getUserProfile, createOrUpdateUserProfile } from "../assets/js/profile-handler.js";

        document.addEventListener('DOMContentLoaded', () => {
            onAuthChange(async (user) => {
                if (user) {
                    // 1. Get Profile
                    let profile = await getUserProfile(user.uid);

                    // 2. If no profile, try to create one (recovery)
                    if (!profile) {
                        console.info("Profile missing in dashboard, attempting recovery...");
                        await createOrUpdateUserProfile(user);
                        profile = await getUserProfile(user.uid);
                    }

                    if (profile) {
                        // 3. Update UI
                        const name = profile.displayName || user.displayName || 'Friend';
                        const email = profile.email || user.email;
                        const phone = profile.phone || '';

                        // Personal Greeting
                        const greetingEl = document.getElementById('welcome-greeting');
                        if (greetingEl) greetingEl.innerHTML = `Welcome back, <span style="color:var(--teal-accent);">${name}</span>.`;

                        // URL Masking (Client-Side Routing Feel) - Makes it look personalized
                        // Only change if not already clean (avoids loop)
                        if (window.history && window.history.replaceState) {
                            // Use replaceState to change URL bar without reload
                            // From: /portal/user-dashboard.html
                            // To:   /portal/my-space
                            const cleanUrl = window.location.href.replace('user-dashboard.html', 'my-space');
                            // window.history.replaceState({}, document.title, cleanUrl);
                            // CAUTION: Only do this if we are confident user won't 404 on refresh.
                            // Since we don't control server rewrites yet, let's stick to a safe query param or hash for now to be safe?
                            // User explicitly asked for "redirected to HIS page". 
                            // Let's settle for a visual hash for now which is 100% safe: #/my-space/aditya
                            // OR just update the greeting as the main "Personal" indicator as per my plan.

                            // Let's go with the greeting update as the primary "Personalization" proof.
                            // And maybe add a hash:
                            // window.location.hash = `/space/${user.uid}`;
                        }

                        // Sidebar
                        const sbName = document.getElementById('sidebar-name');
                        if (sbName) sbName.innerText = name;

                        const sbRole = document.getElementById('sidebar-role');
                        if (sbRole) sbRole.innerText = (profile.role || 'Member');

                        // Settings inputs
                        const inName = document.getElementById('profile-name');
                        if (inName) inName.value = name;

                        const inPhone = document.getElementById('profile-phone');
                        if (inPhone) inPhone.value = phone;

                        const elEmail = document.getElementById('profile-email');
                        if (elEmail) elEmail.innerText = email;

                    }
                } else {
                    console.log("No user found in dashboard.");
                }
            });
        });
    </script>
</body>

</html>