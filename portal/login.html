<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | Soulamore</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../assets/css/global.css">
    <style>
        body {
            margin: 0;
            min-height: 100vh;
            background: #0f172a;
            color: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Plus Jakarta Sans', sans-serif;
            overflow: hidden;
        }

        /* Particles & Ambient Background */
        #ambient-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.3;
            animation: float 10s infinite ease-in-out;
        }

        .orb-1 {
            width: 300px;
            height: 300px;
            background: #4ECDC4;
            top: -50px;
            left: -50px;
        }

        .orb-2 {
            width: 400px;
            height: 400px;
            background: #F49F75;
            bottom: -100px;
            right: -100px;
            animation-delay: -5s;
        }

        @keyframes float {

            0%,
            100% {
                transform: translate(0, 0);
            }

            50% {
                transform: translate(20px, 40px);
            }
        }

        /* Glass Card */
        .gateway-card {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 24px;
            width: 100%;
            max-width: 440px;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            position: relative;
            z-index: 10;
            overflow: hidden;
            transition: height 0.3s ease;
        }

        h1 {
            font-family: 'Outfit', sans-serif;
            margin: 0 0 5px 0;
            font-size: 2rem;
            background: linear-gradient(135deg, #fff 0%, #a5f3fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        p.subtitle {
            color: #94a3b8;
            margin: 0 0 30px 0;
            font-size: 0.95rem;
        }

        /* Provider Buttons */
        .auth-btn {
            width: 100%;
            padding: 14px;
            margin-bottom: 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.03);
            color: white;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.2s;
            font-weight: 500;
        }

        .auth-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateY(-1px);
        }

        .auth-btn.primary {
            background: var(--teal-accent, #4ECDC4);
            color: #0f172a;
            border: none;
            font-weight: 700;
        }

        .auth-btn.primary:hover {
            opacity: 0.9;
        }

        /* Input States (Hidden by default) */
        .input-group {
            display: none;
            text-align: left;
            animation: slideUp 0.3s ease;
        }

        .input-field {
            width: 100%;
            padding: 14px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            margin-bottom: 15px;
            font-family: inherit;
        }

        .input-field:focus {
            outline: none;
            border-color: #4ECDC4;
        }

        .back-btn {
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .back-btn:hover {
            color: white;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Recaptcha Container */
        #recaptcha-container {
            display: none;
        }
    </style>
</head>

<body>

    <div id="ambient-bg">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
    </div>

    <div class="gateway-card" id="main-view">
        <div style="margin-bottom: 30px;">
            <img src="../assets/images/logo.png" alt="Soulamore" style="height: 50px; margin-bottom: 15px;">
            <h1>Welcome Home</h1>
            <p class="subtitle">Log in or sign up seamlessly.</p>
        </div>

        <div id="provider-buttons">
            <button class="auth-btn" onclick="showInput('email')"><i class="fas fa-envelope"></i> Continue with
                Email</button>
            <button class="auth-btn" onclick="showInput('phone')"><i class="fas fa-phone"></i> Continue with
                Phone</button>
            <div style="height: 1px; background: rgba(255,255,255,0.1); margin: 20px 0;"></div>
            <button class="auth-btn" style="background:#fff; color:#333; border:none;" onclick="handleGoogle()"><i
                    class="fab fa-google" style="color:#EA4335;"></i> Continue with Google</button>
            <button class="auth-btn" style="background:#1877F2; color:#fff; border:none;" onclick="handleFacebook()"><i
                    class="fab fa-facebook-f"></i> Continue with Facebook</button>
        </div>

        <div id="email-view" class="input-group">
            <p style="margin-bottom: 15px; opacity: 0.8;">We'll send you a magic link. No password needed.</p>
            <input type="email" id="email-input" class="input-field" placeholder="name@example.com">
            <button class="auth-btn primary" onclick="sendEmailLink()">Send Login Link</button>
            <!-- Fallback to Password Login -->
            <button class="back-btn" onclick="showInput('password-login')"
                style="font-size:0.8rem; margin-top:5px; opacity:0.6;">I have a password</button>
            <button class="back-btn" onclick="resetView()">Back</button>
        </div>

        <div id="password-login-view" class="input-group">
            <p style="margin-bottom: 15px; opacity: 0.8;">Enter your password to login.</p>
            <input type="email" id="pass-email-input" class="input-field" placeholder="name@example.com">
            <input type="password" id="pass-input" class="input-field" placeholder="Password">
            <button class="auth-btn primary" onclick="loginWithPassword()">Log In</button>
            <button class="back-btn" onclick="resetView()">Back</button>
        </div>

        <div id="phone-view" class="input-group">
            <p style="margin-bottom: 15px; opacity: 0.8;">Enter your mobile number.</p>
            <input type="tel" id="phone-input" class="input-field" placeholder="+91 99999 99999" value="+91">
            <button class="auth-btn primary" id="send-otp-btn" onclick="sendOTP()">Send SMS Code</button>
            <button class="back-btn" onclick="resetView()">Back</button>
        </div>

        <div id="otp-view" class="input-group">
            <p style="margin-bottom: 15px; opacity: 0.8;">Enter the code sent to your phone.</p>
            <input type="number" id="otp-input" class="input-field" placeholder="123456"
                style="letter-spacing: 5px; text-align: center;">
            <button class="auth-btn primary" onclick="verifyOTP()">Verify & Login</button>
            <button class="back-btn" onclick="showInput('phone')">Change Number</button>
        </div>
    </div>

    <div id="recaptcha-wrapper"></div>

    <!-- Logic -->
    <script type="module">
        import { startEmailLogin, startPhoneLogin, completePhoneLogin, loginWithGoogle, loginWithFacebook, loginWithEmail, onAuthChange } from "../assets/js/auth-service.js";
        import { RecaptchaVerifier, auth } from "../assets/js/firebase-config.js";
        import { createOrUpdateUserProfile } from "../assets/js/profile-handler.js";

        // State
        let confirmationResult = null;
        let recaptchaVerifier = null;

        // Auto-Redirect if Logged In
        onAuthChange(async (user) => {
            if (user) {
                // Ensure profile exists then redirect
                await createOrUpdateUserProfile(user);

                // Route based on role (simple logic for now)
                // TODO: Improve this with role reading
                window.location.href = 'user-dashboard.html';
            }
        });

        // UI Functions
        window.showInput = (type) => {
            document.getElementById('provider-buttons').style.display = 'none';
            document.querySelectorAll('.input-group').forEach(el => el.style.display = 'none');

            if (type === 'email') document.getElementById('email-view').style.display = 'block';
            if (type === 'phone') {
                document.getElementById('phone-view').style.display = 'block';
                initRecaptcha(); // Init early
            }
            if (type === 'password-login') document.getElementById('password-login-view').style.display = 'block';
        };

        window.resetView = () => {
            document.querySelectorAll('.input-group').forEach(el => el.style.display = 'none');
            document.getElementById('provider-buttons').style.display = 'block';
            document.getElementById('provider-buttons').classList.add('fade-in');
        };

        // --- EMAIL LINK ---
        window.sendEmailLink = async () => {
            const email = document.getElementById('email-input').value;
            if (!email) return alert("Please enter an email");

            const btn = document.querySelector('#email-view .primary');
            btn.innerText = "Sending...";

            const result = await startEmailLogin(email);
            if (result.success) {
                alert(`Login link sent to ${email}. Check your inbox!`);
                btn.innerText = "Link Sent";
            } else {
                alert(result.error);
                btn.innerText = "Send Login Link";
            }
        };

        // --- PASSWORD LOGIN (Legacy Support) ---
        window.loginWithPassword = async () => {
            const email = document.getElementById('pass-email-input').value;
            const pass = document.getElementById('pass-input').value;

            if (!email || !pass) return alert("Please enter credentials");

            const result = await loginWithEmail(email, pass);
            if (!result.success) {
                alert(result.error);
            }
            // Success handled by onAuthChange
        };

        // --- PHONE AUTH ---
        function initRecaptcha() {
            if (!recaptchaVerifier) {
                // Invisible Recaptcha
                recaptchaVerifier = new RecaptchaVerifier(auth, 'send-otp-btn', {
                    'size': 'invisible',
                    'callback': (response) => {
                        // reCAPTCHA solved, allow signInWithPhoneNumber.
                        // window.sendOTP();
                    }
                });
            }
        }

        window.sendOTP = async () => {
            const phone = document.getElementById('phone-input').value;
            if (!phone) return alert("Enter phone number");

            const result = await startPhoneLogin(phone, recaptchaVerifier);
            if (result.success) {
                confirmationResult = result.confirmationResult;
                // Switch View
                document.getElementById('phone-view').style.display = 'none';
                document.getElementById('otp-view').style.display = 'block';
            } else {
                alert(result.error);
                // Reset Recaptcha
                if (recaptchaVerifier) recaptchaVerifier.clear();
                recaptchaVerifier = null;
                initRecaptcha();
            }
        };

        window.verifyOTP = async () => {
            const code = document.getElementById('otp-input').value;
            const result = await completePhoneLogin(confirmationResult, code);
            if (!result.success) {
                alert(result.error);
            }
        };

        // --- SOCIAL ---
        window.handleGoogle = async () => {
            const result = await loginWithGoogle();
            if (!result.success) alert(result.error);
        };

        window.handleFacebook = async () => {
            const result = await loginWithFacebook();
            if (!result.success) alert(result.error);
        };
    </script>
</body>

</html>