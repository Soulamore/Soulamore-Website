<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book with Renu Dogra | Soulamore</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../../../assets/css/global.css">

    <!-- FIREBASE & COMPONENTS -->
    <script type="module" src="../../../assets/js/firebase-config.js"></script>
    <script type="module" src="../../../assets/js/components.js"></script>

    <style>
        :root {
            --deep-space: #0f172a;
            --navy-glass: rgba(30, 41, 59, 0.9);
            --starlight: #f8fafc;
            --saffron-glow: #f59e0b;
            --teal-chakra: #2dd4bf;
            --border-glass: rgba(255, 255, 255, 0.15);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--deep-space);
            color: var(--starlight);
            margin: 0;
            padding: 0;
        }

        .page-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            padding: 120px 24px 60px;
        }

        @media (max-width: 600px) {
            .page-wrapper {
                padding: 100px 12px 60px;
                /* More space for calendar */
            }
        }

        .booking-header {
            text-align: center;
            margin-bottom: 60px;
        }

        .booking-header h1 {
            font-family: 'Outfit', sans-serif;
            font-size: 2.5rem;
            color: var(--starlight);
            margin-bottom: 10px;
        }

        .booking-header .peer-name {
            font-size: 1.2rem;
            color: var(--saffron-glow);
            margin-bottom: 20px;
        }

        /* Booking Steps */
        .booking-steps {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 24px;
            background: var(--navy-glass);
            border: 1px solid var(--border-glass);
            border-radius: 30px;
            font-size: 0.9rem;
            transition: 0.3s;
        }

        .step.active {
            background: linear-gradient(135deg, var(--saffron-glow), #d97706);
            border-color: var(--saffron-glow);
            color: var(--deep-space);
            font-weight: 600;
        }

        .step.completed {
            background: rgba(45, 212, 191, 0.2);
            border-color: var(--teal-chakra);
        }

        /* Main Booking Container */
        .booking-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 40px;
        }

        @media (max-width: 968px) {
            .booking-container {
                grid-template-columns: 1fr;
            }
        }

        /* Pricing Plans Section */
        .plans-section {
            background: var(--navy-glass);
            border: 1px solid var(--border-glass);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }

        .plans-section h2 {
            font-family: 'Outfit', sans-serif;
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: var(--saffron-glow);
        }

        .plans-grid {
            display: grid;
            gap: 15px;
        }

        .plan-card {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid var(--border-glass);
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: 0.3s;
            position: relative;
        }

        .plan-card:hover {
            border-color: var(--saffron-glow);
            background: rgba(245, 158, 11, 0.1);
            transform: translateY(-2px);
        }

        .plan-card.selected {
            border-color: var(--saffron-glow);
            background: rgba(245, 158, 11, 0.2);
        }

        .plan-card.selected::before {
            content: '✓';
            position: absolute;
            top: 15px;
            right: 15px;
            width: 24px;
            height: 24px;
            background: var(--saffron-glow);
            color: var(--deep-space);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .plan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .plan-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--starlight);
        }

        .plan-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--saffron-glow);
        }

        .plan-details {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .plan-savings {
            font-size: 0.85rem;
            color: var(--teal-chakra);
            font-weight: 500;
        }

        /* Calendar Section */
        .calendar-section {
            background: var(--navy-glass);
            border: 1px solid var(--border-glass);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }

        .calendar-section h2 {
            font-family: 'Outfit', sans-serif;
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: var(--saffron-glow);
        }

        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-nav button {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-glass);
            color: var(--starlight);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.3s;
        }

        .calendar-nav button:hover {
            background: rgba(245, 158, 11, 0.2);
            border-color: var(--saffron-glow);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .calendar-day-header {
            text-align: center;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--teal-chakra);
            padding: 8px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border-glass);
            border-radius: 8px;
            cursor: pointer;
            transition: 0.3s;
            font-size: 0.9rem;
        }

        .calendar-day:hover {
            background: rgba(245, 158, 11, 0.1);
            border-color: var(--saffron-glow);
        }

        .calendar-day.available {
            background: rgba(45, 212, 191, 0.1);
            border-color: var(--teal-chakra);
            cursor: pointer;
        }

        .calendar-day.selected {
            background: var(--saffron-glow);
            color: var(--deep-space);
            font-weight: 600;
        }

        .calendar-day.unavailable {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        /* Time Slots */
        .time-slots {
            margin-top: 20px;
        }

        .time-slots h3 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: var(--starlight);
        }

        .slots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }

        .time-slot {
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-glass);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            font-size: 0.9rem;
        }

        .time-slot:hover {
            background: rgba(245, 158, 11, 0.2);
            border-color: var(--saffron-glow);
        }

        .time-slot.selected {
            background: var(--saffron-glow);
            color: var(--deep-space);
            font-weight: 600;
            border-color: var(--saffron-glow);
        }

        .time-slot.unavailable {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Summary Section */
        .summary-section {
            background: var(--navy-glass);
            border: 1px solid var(--border-glass);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            margin-top: 40px;
        }

        .summary-section h2 {
            font-family: 'Outfit', sans-serif;
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: var(--saffron-glow);
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-glass);
        }

        .summary-item:last-child {
            border-bottom: none;
            font-size: 1.2rem;
            font-weight: 600;
            margin-top: 10px;
        }

        .summary-label {
            opacity: 0.8;
        }

        .summary-value {
            color: var(--saffron-glow);
            font-weight: 600;
        }

        /* Book Button */
        .book-button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--saffron-glow), #d97706);
            border: none;
            border-radius: 12px;
            color: var(--deep-space);
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 20px;
        }

        .book-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
        }

        .book-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(15, 23, 42, 0.3);
            border-top-color: var(--deep-space);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 40px;
            opacity: 0.6;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--teal-chakra);
        }
    </style>
</head>

<body>
    <div id="header"></div>

    <div class="page-wrapper">
        <!-- Booking Header -->
        <div class="booking-header">
            <h1>Book a Session</h1>
            <div class="peer-name">Renu Dogra - Physical Wellness Peer</div>
        </div>

        <!-- Booking Steps -->
        <div class="booking-steps">
            <div class="step active" data-step="1">
                <span>1</span> <span>Select Plan</span>
            </div>
            <div class="step" data-step="2">
                <span>2</span> <span>Choose Date & Time</span>
            </div>
            <div class="step" data-step="3">
                <span>3</span> <span>Review & Pay</span>
            </div>
        </div>

        <!-- Main Booking Container -->
        <div class="booking-container">
            <!-- Pricing Plans Section -->
            <div class="plans-section">
                <h2>Choose Your Plan</h2>
                <div class="plans-grid" id="plansGrid">
                    <!-- Plans will be populated by JavaScript -->
                </div>
            </div>

            <!-- Calendar Section -->
            <div class="calendar-section">
                <h2>Select Date & Time</h2>

                <!-- Calendar Navigation -->
                <div class="calendar-nav">
                    <button id="prevMonth"><i class="fas fa-chevron-left"></i></button>
                    <div id="currentMonth" style="font-size: 1.1rem; font-weight: 600;"></div>
                    <button id="nextMonth"><i class="fas fa-chevron-right"></i></button>
                </div>

                <!-- Calendar Grid -->
                <div class="calendar-grid" id="calendarGrid">
                    <!-- Calendar will be populated by JavaScript -->
                </div>

                <!-- Time Slots -->
                <div class="time-slots" id="timeSlotsSection" style="display: none;">
                    <h3>Available Time Slots</h3>
                    <div class="slots-grid" id="timeSlotsGrid">
                        <!-- Time slots will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Section -->
        <div class="summary-section" id="summarySection" style="display: none;">
            <h2>Booking Summary</h2>
            <div class="summary-item">
                <span class="summary-label">Plan:</span>
                <span class="summary-value" id="summaryPlan">-</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Date:</span>
                <span class="summary-value" id="summaryDate">-</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Time:</span>
                <span class="summary-value" id="summaryTime">-</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Duration:</span>
                <span class="summary-value">60 minutes</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Total Amount:</span>
                <span class="summary-value" id="summaryAmount">₹0</span>
            </div>
            <button class="book-button" id="bookButton" disabled>
                Proceed to Payment
            </button>
        </div>
    </div>

    <script type="module">
        import { auth, onAuthStateChanged, db, doc, getDoc } from "../../../assets/js/firebase-config.js";
        import {
            PEER_PLAN_TYPES,
            DEFAULT_PLANS,
            getPeerAvailability,
            getAvailableSlots,
            createBookingRequest
        } from "../../../assets/js/peer-booking-handler.js";
        import { openRazorpayCheckout } from "../../../assets/js/payment-handler.js";

        // Configuration
        const PEER_ID = "renu-dogra-peer-id"; // Replace with actual peer ID from database
        const SESSION_DURATION_MINUTES = 60;

        // State
        let selectedPlan = null;
        let selectedDate = null;
        let selectedTimeSlot = null;
        let currentMonth = new Date();
        let availability = null;
        let currentUserId = null;

        // Initialize
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                initBooking();
            } else {
                alert("Please log in to book a session.");
                window.location.href = "/auth/login.html";
            }
        });

        async function initBooking() {
            await loadAvailability();
            renderPlans();
            renderCalendar();
            setupEventListeners();
        }

        async function loadAvailability() {
            try {
                availability = await getPeerAvailability(PEER_ID);
                if (!availability) {
                    // Set default availability (Monday to Friday, 9 AM to 5 PM)
                    const defaultAvailability = [
                        { day: 'monday', startTime: '09:00', endTime: '17:00' },
                        { day: 'tuesday', startTime: '09:00', endTime: '17:00' },
                        { day: 'wednesday', startTime: '09:00', endTime: '17:00' },
                        { day: 'thursday', startTime: '09:00', endTime: '17:00' },
                        { day: 'friday', startTime: '09:00', endTime: '17:00' }
                    ];
                    availability = { availability: defaultAvailability };
                }
            } catch (error) {
                console.error("Error loading availability:", error);
            }
        }

        function renderPlans() {
            const plansGrid = document.getElementById('plansGrid');
            plansGrid.innerHTML = '';

            Object.values(PEER_PLAN_TYPES).forEach(planType => {
                const plan = DEFAULT_PLANS[planType];
                const planCard = document.createElement('div');
                planCard.className = 'plan-card';
                planCard.dataset.planType = planType;

                const savings = planType === PEER_PLAN_TYPES.PER_SESSION ? '' :
                    `<div class="plan-savings">Save ${Math.round((1 - (plan.price / (DEFAULT_PLANS[PEER_PLAN_TYPES.PER_SESSION].price * plan.sessions))) * 100)}%</div>`;

                planCard.innerHTML = `
                    <div class="plan-header">
                        <div class="plan-name">${plan.name}</div>
                        <div class="plan-price">₹${plan.price}</div>
                    </div>
                    <div class="plan-details">${plan.description}</div>
                    ${savings}
                `;

                planCard.addEventListener('click', () => selectPlan(planType));
                plansGrid.appendChild(planCard);
            });
        }

        function selectPlan(planType) {
            selectedPlan = planType;

            // Update UI
            document.querySelectorAll('.plan-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-plan-type="${planType}"]`).classList.add('selected');

            // Update steps
            updateSteps(1);
            updateSummary();
        }

        function renderCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            const currentMonthEl = document.getElementById('currentMonth');

            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();

            currentMonthEl.textContent = currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            // Clear previous calendar
            calendarGrid.innerHTML = '';

            // Day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                calendarGrid.appendChild(header);
            });

            // First day of month
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - startDate.getDay());

            // Render calendar days
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);

                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.textContent = date.getDate();

                // Check if date is in current month
                if (date.getMonth() !== month) {
                    dayEl.classList.add('other-month');
                }

                // Check if date is in the past
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const dateOnly = new Date(date);
                dateOnly.setHours(0, 0, 0, 0);

                if (dateOnly < today) {
                    dayEl.classList.add('unavailable');
                } else {
                    // Check if date has availability
                    const dayName = date.toLocaleDateString('en-US', { weekday: 'long' }).toLowerCase();
                    const daySchedule = availability?.availability?.find(slot => slot.day.toLowerCase() === dayName);

                    if (daySchedule) {
                        dayEl.classList.add('available');
                        dayEl.addEventListener('click', () => selectDate(date));
                    } else {
                        dayEl.classList.add('unavailable');
                    }
                }

                calendarGrid.appendChild(dayEl);
            }

            // Highlight selected date
            if (selectedDate) {
                highlightSelectedDate();
            }
        }

        function highlightSelectedDate() {
            if (!selectedDate) return;

            document.querySelectorAll('.calendar-day').forEach(day => {
                day.classList.remove('selected');
                const dayDate = parseInt(day.textContent);
                if (dayDate === selectedDate.getDate() && day.classList.contains('available')) {
                    day.classList.add('selected');
                }
            });
        }

        async function selectDate(date) {
            selectedDate = new Date(date);
            selectedTimeSlot = null;

            // Update calendar UI
            document.querySelectorAll('.calendar-day').forEach(day => day.classList.remove('selected'));
            event.target.classList.add('selected');

            // Load available time slots
            await loadTimeSlots();

            // Update steps
            updateSteps(2);
            updateSummary();
        }

        async function loadTimeSlots() {
            if (!selectedDate) return;

            const timeSlotsSection = document.getElementById('timeSlotsSection');
            const timeSlotsGrid = document.getElementById('timeSlotsGrid');

            timeSlotsSection.style.display = 'block';
            timeSlotsGrid.innerHTML = '<div class="loading">Loading slots...</div>';

            try {
                const slots = await getAvailableSlots(PEER_ID, selectedDate);

                if (slots.length === 0) {
                    timeSlotsGrid.innerHTML = '<div class="empty-state"><i class="fas fa-calendar-times"></i><p>No available slots for this date</p></div>';
                    return;
                }

                timeSlotsGrid.innerHTML = '';
                slots.forEach(slot => {
                    const slotEl = document.createElement('div');
                    slotEl.className = 'time-slot';
                    slotEl.textContent = slot.display;
                    slotEl.dataset.start = slot.start.toISOString();
                    slotEl.dataset.end = slot.end.toISOString();

                    slotEl.addEventListener('click', () => selectTimeSlot(slotEl, slot));

                    timeSlotsGrid.appendChild(slotEl);
                });
            } catch (error) {
                console.error("Error loading time slots:", error);
                timeSlotsGrid.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Error loading slots. Please try again.</p></div>';
            }
        }

        function selectTimeSlot(slotEl, slot) {
            selectedTimeSlot = slot;

            // Update UI
            document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
            slotEl.classList.add('selected');

            // Update steps
            updateSteps(2);
            updateSummary();
        }

        function updateSteps(activeStep) {
            document.querySelectorAll('.step').forEach((step, index) => {
                step.classList.remove('active', 'completed');
                if (index + 1 < activeStep) {
                    step.classList.add('completed');
                } else if (index + 1 === activeStep) {
                    step.classList.add('active');
                }
            });
        }

        function updateSummary() {
            const summarySection = document.getElementById('summarySection');
            const bookButton = document.getElementById('bookButton');

            if (selectedPlan && selectedDate && selectedTimeSlot) {
                summarySection.style.display = 'block';

                const plan = DEFAULT_PLANS[selectedPlan];
                document.getElementById('summaryPlan').textContent = plan.name;
                document.getElementById('summaryDate').textContent = selectedDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                document.getElementById('summaryTime').textContent = selectedTimeSlot.display;
                document.getElementById('summaryAmount').textContent = `₹${plan.price}`;

                bookButton.disabled = false;
            } else {
                summarySection.style.display = 'none';
                bookButton.disabled = true;
            }
        }

        function setupEventListeners() {
            // Calendar navigation
            document.getElementById('prevMonth').addEventListener('click', () => {
                currentMonth.setMonth(currentMonth.getMonth() - 1);
                renderCalendar();
            });

            document.getElementById('nextMonth').addEventListener('click', () => {
                currentMonth.setMonth(currentMonth.getMonth() + 1);
                renderCalendar();
            });

            // Book button
            document.getElementById('bookButton').addEventListener('click', handleBooking);
        }

        async function handleBooking() {
            if (!selectedPlan || !selectedDate || !selectedTimeSlot || !currentUserId) {
                alert("Please complete all booking steps.");
                return;
            }

            const bookButton = document.getElementById('bookButton');
            bookButton.disabled = true;
            bookButton.innerHTML = 'Processing... <span class="loading"></span>';

            try {
                // Create booking request
                const bookingResult = await createBookingRequest(
                    currentUserId,
                    PEER_ID,
                    selectedPlan,
                    selectedTimeSlot.start,
                    selectedTimeSlot.end
                );

                // Get user details for payment
                const user = auth.currentUser;
                const userDoc = await getDoc(doc(db, 'users', currentUserId));
                const userData = userDoc.exists() ? userDoc.data() : {};

                // Open Razorpay checkout
                const plan = DEFAULT_PLANS[selectedPlan];
                await openRazorpayCheckout(
                    bookingResult.bookingId,
                    bookingResult.amount,
                    currentUserId,
                    userData.name || user.displayName || 'User',
                    user.email || '',
                    userData.phone || '',
                    {
                        planName: plan.name,
                        planType: selectedPlan
                    }
                );

                // Payment successful - redirect to confirmation
                window.location.href = `/our-peers/physical-wellness/booking-confirmation.html?bookingId=${bookingResult.bookingId}`;
            } catch (error) {
                console.error("Booking error:", error);
                alert(error.message || "Failed to process booking. Please try again.");
                bookButton.disabled = false;
                bookButton.textContent = 'Proceed to Payment';
            }
        }
    </script>
</body>

</html>